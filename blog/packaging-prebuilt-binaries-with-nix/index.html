<!doctype html><html lang=en><title>Packaging pre-built binaries with nix - sekun</title><link href=/assets/css/style.css rel=stylesheet><link href=/assets/images/favicon.ico rel=icon><link href=/assets/images/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/assets/images/apple-touch-icon.png rel=apple-touch-icon><link href=/assets/images/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/assets/images/safari-pinned-tab.svg rel=mask-icon><meta content="width=device-width,initial-scale=1.0" name=viewport><meta charset=UTF-8><meta content="Packaging pre-built binaries with nix" name=title><meta content="Here's the scenario: You have a nix environment all set up with all the
dependencies you need for working on your next awesome project. All but one.
`nixpkgs` doesn't have the version you want. Fortunately, there's a static
binary file on their GitHub page. So should you just manually download it
every time you set your project up, or should you write a Nix package that
builds it from source?
" name=description><meta content=website property=og:type><meta content=https://metatags.io/ property=og:url><meta content="Packaging pre-built binaries with nix" property=og:title><meta content="Here's the scenario: You have a nix environment all set up with all the
dependencies you need for working on your next awesome project. All but one.
`nixpkgs` doesn't have the version you want. Fortunately, there's a static
binary file on their GitHub page. So should you just manually download it
every time you set your project up, or should you write a Nix package that
builds it from source?
" property=og:description><meta content=https://sekun.net/assets/images/posts/packaging-prebuilt-binaries-with-nix/cover.jpg property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://metatags.io/ property=twitter:url><meta content="Packaging pre-built binaries with nix" property=twitter:title><meta content="Here's the scenario: You have a nix environment all set up with all the
dependencies you need for working on your next awesome project. All but one.
`nixpkgs` doesn't have the version you want. Fortunately, there's a static
binary file on their GitHub page. So should you just manually download it
every time you set your project up, or should you write a Nix package that
builds it from source?
" property=twitter:description><meta content=https://sekun.net/assets/images/posts/packaging-prebuilt-binaries-with-nix/cover.jpg property=twitter:image><body><nav class=nav><ul><li><a href=/>λsekun.net</a><li><a href=/blog>/blog</a><li><a href=/projects>/projects</a><li><a href=/contact>/contact</a></ul></nav><h1 id=packaging-pre-built-binaries-with-nix><a href=#packaging-pre-built-binaries-with-nix>Packaging pre-built binaries with nix</a></h1><div></div><div><x-img> <template shadowrootmode=open><img alt="Text " binaries flakes"" nix packaging prebuilt src=/assets/images/posts/packaging-prebuilt-binaries-with-nix/cover.jpg static with> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><span class=post-metadata> Published on <time datetime=2022-03-06T04:11:00+00:00>2022-03-06 04:11 UTC</time> </span><div><div class=tags><span>nix</span><span>postgrest</span></div></div><p>Here’s the scenario: You have a nix environment all set up with all the dependencies you need for working on your next awesome project. All but one. <code>nixpkgs</code> doesn’t have the version you want. Fortunately, there’s a static binary file on their GitHub page. So should you just manually download it every time you set your project up, or should you write a Nix package that builds it from source?<p>None of em! I don’t want to maintain any bash scripts to do that. I just want to load up the Nix environment, and start.<p>That was pretty much what I ran into today, I wanted to have <a href=https://postgrest.org><code>postgrest</code></a> in my Nix environment so I hopped on <code>nixpkgs</code> search, only to find that the existing versions are quite old, as well as having to build the project from source. Which I didn’t want to do due to my limited LTE bandwidth. Why should I? <code>postgrest</code> has pre-built, <em>static</em> binaries in its GitHub releases page. Is there any way I can make use of that instead? And that’s what I set off to do today.<p><em>tl;dr: Binaries are built, me copy. Me save mobile data. Happy.</em><blockquote><p>Disclaimer: I’m a Nix newbie.</blockquote><h2 id=setup><a href=#setup>Setup</a></h2><p>I need to import the <code>postgrest</code> flake to an existing flake of another project. The project’s directory has a <code>nix</code> folder for all the packages that don’t exist in <code>nixpkgs</code>, like so:<pre style=background-color:#282828>
<span style=color:#8ec07c>nix
</span><span style=color:#8ec07c>└──</span><span style=color:#fbf1c7> postgrest
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>├──</span><span style=color:#fbf1c7> flake.lock
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>└──</span><span style=color:#fbf1c7> flake.nix
</span></pre><p>The <code>flake.lock</code> gets automatically generated by Nix when it finds out that it doesn’t exist yet when running <code>nix build</code>; no need to create that. Here’s the starting <code>flake.nix</code>:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>REST API for any Postgres database</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs}: { };
</span><span style=color:#fbf1c7>}
</span></pre><p>A basic flake file has a set of inputs and outputs. The output here will be the <code>postgrest</code> package.<p>Time to throw the binary in Nix.<p>I have no idea how to build things in flakes, so consulting the wiki is pretty much a requirement <sup class=footnote-reference><a href=#1>1</a></sup>! It covers things like how to enable flakes, and I won’t bother covering because I’ll only make a worse version of it.<p>It tells me about both the <code>inputs</code> and <code>outputs</code> schema. But because I only need <code>nixpkgs</code> for this one, there’s not much else for me to add to the <code>inputs</code>.<p>Here’s the output schema:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{ self</span><span style=color:#8ec07c>, ... </span><span style=color:#fbf1c7>}@inputs:
</span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Executed by `nix flake check`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>checks</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Executed by `nix build .#&lt;name>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>packages</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Executed by `nix build .`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>defaultPackage</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Executed by `nix run .#&lt;name>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>apps</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>type </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>app</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>program </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>&lt;store-path></span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Executed by `nix run . -- &lt;args?>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>defaultApp</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ </span><span style=color:#fabd2f>type </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>app</span><span style=color:#fbf1c7>"; </span><span style=color:#fabd2f>program </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>...</span><span style=color:#fbf1c7>"; };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used for nixpkgs packages, also accessible via `nix build .#&lt;name>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>legacyPackages</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Default overlay, consumed by other flakes
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>overlay </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>final: prev: { };
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Same idea as overlay but a list or attrset of them.
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>overlays </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{};
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Default module, consumed by other flakes
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>nixosModule </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ config }: { </span><span style=color:#fabd2f>options </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{}; </span><span style=color:#fabd2f>config </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{}; };
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Same idea as nixosModule but a list or attrset of them.
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>nixosModules </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{};
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used with `nixos-rebuild --flake .#&lt;hostname>`
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># nixosConfigurations."&lt;hostname>".config.system.build.toplevel must be a derivation
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>nixosConfigurations</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;hostname></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{};
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used by `nix develop`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>devShell</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used by `nix develop .#&lt;name>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>devShells</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Hydra build jobs
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>hydraJobs</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;attr></span><span style=color:#fbf1c7>"."</span><span style=color:#b8bb26>&lt;system></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= derivation</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used by `nix flake init -t &lt;flake>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>defaultTemplate </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>path </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>&lt;store-path></span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>template description goes here?</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Used by `nix flake init -t &lt;flake>#&lt;name>`
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>templates</span><span style=color:#fbf1c7>."</span><span style=color:#b8bb26>&lt;name></span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ </span><span style=color:#fabd2f>path </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>&lt;store-path></span><span style=color:#fbf1c7>"; </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>""; };
</span><span style=color:#fbf1c7>}
</span></pre><p>That’s a lot.<p><code>outputs</code> is a lambda with a set as its argument. Since nix functions can only have one argument, putting the stuff you need in a set is how you get around that restriction. <code>{self, ...}</code> is some form of pattern matching the fields in a set, and <code>@inputs</code> binds the set to <code>input</code>. Cool. The latter isn’t that useful to me in this scenario though, so I’ll omit that. It seems that in every flake <code>outputs</code>, <code>self</code> must be there. I don’t understand what <code>self</code> is, but I’ll leave that for another time.<p>With the schema, there are two fields that <em>seem</em> important: <code>packages</code>, and <code>defaultPackage</code>. <code>packages</code> would be useful if I wanted to have multiple versions of <code>postgrest</code> available for me to use like <code>postgres-8-0-0</code> and <code>postgrest-9-0-0</code>, but I don’t! I only need the latest version, which is <code>9.0.0</code> at the time of writing. So we can ignore that, and I’ll use <code>defaultPackage</code> instead.<p>Here’s what we have so far:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>REST API for any Postgres database</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs}: {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>defaultPackage</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>x86_64-linux </span><span style=color:#8ec07c>=
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>with </span><span style=color:#8ec07c>import </span><span style=color:#fbf1c7>nixpkgs { </span><span style=color:#fabd2f>system </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>x86_64-linux</span><span style=color:#fbf1c7>"; };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      stdenv</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkDerivation </span><span style=color:#fb4934>rec </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>name </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>postgrest-</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>version </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>9.0.0</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic># I still lack stuff here!
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>}
</span></pre><p><code>with import nixpkgs {system = "x86_64-linux"};</code> spares me from having to qualify everything like <code>nixpkgs.system."x86_64".stdenv.mkDerivation</code> which is handy <sup class=footnote-reference><a href=#2>2</a></sup>. This brings <code>stdenv</code> into scope, and has <code>mkDerivation</code> which, from the name, makes a <code>derivation</code>; something I need for <code>defaultPackage.&lt;system></code>. Unfortunately, I couldn’t find any official documentation for <code>mkDerivation</code> that specifies every single field usable in it. Maybe it exists and that I just suck at Googling. That is definitely possible. There are some examples <sup class=footnote-reference><a href=#3>3</a></sup>, especially in the wild.<p><code>rec</code> allows me to refer to the set’s own fields within it. I’m using the field <code>version</code> and interpolated it in <code>name</code>!<p>Alright that’s it for the setup. Time to fetch the binary.<h2 id=fetching-the-binary><a href=#fetching-the-binary>Fetching the binary</a></h2><p>The wiki has an example for fetching stuff from a URL, and using it in <code>mkDerivation</code> <sup class=footnote-reference><a href=#4>4</a></sup>.<pre style=background-color:#282828>
<span style=color:#fbf1c7>src </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> fetchurl {
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://download.studio.link/releases/v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>-stable/linux/studio-link-standalone-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>.tar.gz</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>sha256 </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>sha256-4CkijAlenhht8tyk3nBULaBPE0GBf6DVII699/RmmWI=</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>}</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p>So it looks like I need two things, a <code>url</code> which can be a <code>tar</code> file, and a <code>sha256</code>. The <code>sha256</code> field is used to make something impure a little bit less unpredictable. If the release were somehow to change under the same name, then it would fail cause the SHA would have a different signature.<p>But… how does one get the SHA? A trick is to just leave it blank. Nix will inform you and make a comparison of the expected vs actual signature.<p>Add this in the <code>outputs</code> schema:<pre style=background-color:#282828>
<span style=color:#fbf1c7>src </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>fetchurl {
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># Remember `rec`!
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://github.com/PostgREST/postgrest/releases/download/v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>/postgrest-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>-linux-static-x64.tar.xz</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>sha256 </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"";
</span><span style=color:#fbf1c7>}</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p>and run <code>nix build</code> in the directory with this <code>flake.nix</code> file.<pre style=background-color:#282828>
<span style=color:#8ec07c>sekun@nixos </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>/P/g/n/postgrest (feature/postgrest)</span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> nix </span><span style=color:#8ec07c>build
</span><span style=color:#8ec07c>warning:</span><span style=color:#fbf1c7> Git tree '</span><span style=color:#b8bb26>/home/sekun/Projects/gnawex</span><span style=color:#fbf1c7>' is dirty
</span><span style=color:#8ec07c>warning:</span><span style=color:#fbf1c7> found empty hash, assuming '</span><span style=color:#b8bb26>sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=</span><span style=color:#fbf1c7>'
</span><span style=color:#8ec07c>error:</span><span style=color:#fbf1c7> hash mismatch in fixed-output derivation '</span><span style=color:#b8bb26>/nix/store/mag8ly8f0rlw5dqxj7ir8maa1bqgkyxv-postgrest-v9.0.0-linux-static-x64.tar.xz.drv</span><span style=color:#fbf1c7>':
</span><span style=color:#fbf1c7>         </span><span style=color:#8ec07c>specified:</span><span style=color:#fbf1c7> sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
</span><span style=color:#fbf1c7>            </span><span style=color:#8ec07c>got:</span><span style=color:#fbf1c7>    sha256-6kgh6heVV7qNcNzcXTiqbVyhfsSV9u5/S3skto6Uzz4=
</span><span style=color:#8ec07c>error:</span><span style=color:#fbf1c7> 1 dependencies of derivation '</span><span style=color:#b8bb26>/nix/store/yg6adsask3s2sg636m5dwy0c79dadg9g-postgrest-9.0.0.drv</span><span style=color:#fbf1c7>' failed to build
</span><span style=color:#8ec07c>sekun@nixos </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>/P/g/n/postgrest (feature/postgrest) </span><span style=color:#8ec07c>[1]>
</span></pre><p>It does fail, as expected. This is how it’ll be if ever the signature were to change. But there it is! It tells us what we specified, and what Nix got. So let’s yoink that and slap it in the schema.<pre style=background-color:#282828>
<span style=color:#fbf1c7>src </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>fetchurl {
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://github.com/PostgREST/postgrest/releases/download/v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>/postgrest-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>-linux-static-x64.tar.xz</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>sha256 </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>sha256-6kgh6heVV7qNcNzcXTiqbVyhfsSV9u5/S3skto6Uzz4=</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>}</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p>Now that we have the binary, all that’s left is to install it.<h2 id=installing><a href=#installing>Installing</a></h2><p>Going back to the example in <sup class=footnote-reference><a href=#4>4</a></sup>:<pre style=background-color:#282828>
<span style=color:#fbf1c7>stdenv</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkDerivation </span><span style=color:#fb4934>rec </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>name </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>studio-link-</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>version </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>21.07.0</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>src </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>fetchurl {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://download.studio.link/releases/v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>-stable/linux/studio-link-standalone-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>.tar.gz</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>sha256 </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>sha256-4CkijAlenhht8tyk3nBULaBPE0GBf6DVII699/RmmWI=</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>nativeBuildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[
</span><span style=color:#fbf1c7>    autoPatchelfHook
</span><span style=color:#fbf1c7>  ];
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>buildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[
</span><span style=color:#fbf1c7>    alsaLib
</span><span style=color:#fbf1c7>    openssl
</span><span style=color:#fbf1c7>    zlib
</span><span style=color:#fbf1c7>    pulseaudio
</span><span style=color:#fbf1c7>  ];
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>sourceRoot </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>.</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>installPhase </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>''
</span><span style=color:#b8bb26>    install -m755 -D studio-link-standalone-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26> $out/bin/studio-link
</span><span style=color:#b8bb26>  </span><span style=color:#fbf1c7>'';
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>meta </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>with </span><span style=color:#fbf1c7>lib; {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>homepage </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://studio-link.com</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Voip transfer</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>platforms </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>platforms</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>linux;
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>}
</span></pre><p>We can ignore <code>nativeBuildInputs</code> and <code>buildInputs</code> since those are used for declaring what dependencies should be there when building something. In this case, there’s nothing to build because we just got a pre-built binary. Nor do we have to provide any runtime dependencies because it’s a static binary. That leaves <code>sourceRoot</code>, <code>installPhase</code>, and <code>meta</code> left. I tried looking for more information about <code>sourceRoot</code> found some explanations but I was left unsure if I needed it. Let’s leave that out for now. We do need <code>installPhase</code> since we have to send it off to the Nix store. It looks like I can reuse this without much changes.<pre style=background-color:#282828>
<span style=color:#8ec07c>installPhase</span><span style=color:#fbf1c7> = ''
</span><span style=color:#8ec07c>install</span><span style=color:#fbf1c7> -m755 -D postgrest </span><span style=color:#458588>$</span><span style=color:#83a598>out</span><span style=color:#fbf1c7>/bin/postgrest
</span><span style=color:#fbf1c7>''</span><span style=color:#8ec07c>;
</span></pre><p>I have no idea what <code>install</code> is. And as usual, check the manual/wiki! The manual description tells me it’s how one copies files while setting attributes. <code>-m755</code> sets the permissions to <code>755</code>, <code>postgrest</code> is the source, and <code>$out/bin/postgrest</code> is the target. <code>$out</code> is set by Nix, which points to the Nix store with the package’s name for the folder. Alright, cool!<p>Time to run <code>nix build</code> again to see if this works.<p>…and it doesn’t.<pre style=background-color:#282828>
<span style=color:#8ec07c>sekun@nixos </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>/P/g/n/postgrest (feature/postgrest) </span><span style=color:#8ec07c>[1]></span><span style=color:#fbf1c7> nix build
</span><span style=color:#8ec07c>warning:</span><span style=color:#fbf1c7> Git tree '</span><span style=color:#b8bb26>/home/sekun/Projects/gnawex</span><span style=color:#fbf1c7>' is dirty
</span><span style=color:#8ec07c>error:</span><span style=color:#fbf1c7> builder for '</span><span style=color:#b8bb26>/nix/store/jsxk8q3handkprh5ma102v8y1dig9k77-postgrest-9.0.0.drv</span><span style=color:#fbf1c7>' failed with exit code 1</span><span style=color:#8ec07c>;
</span><span style=color:#fbf1c7>       </span><span style=color:#8ec07c>last</span><span style=color:#fbf1c7> 3 log lines:
</span><span style=color:#fbf1c7>       </span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> unpacking </span><span style=color:#8ec07c>sources
</span><span style=color:#fbf1c7>       </span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> unpacking </span><span style=color:#8ec07c>source</span><span style=color:#fbf1c7> archive /nix/store/644yqp1y3cgw45qfqsbxb013hm4r2zw6-postgrest-v9.0.0-linux-static-x64.tar.xz
</span><span style=color:#fbf1c7>       </span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> unpacker </span><span style=color:#8ec07c>appears</span><span style=color:#fbf1c7> to have produced no directories
</span><span style=color:#fbf1c7>       </span><span style=color:#8ec07c>For</span><span style=color:#fbf1c7> full logs, run '</span><span style=color:#b8bb26>nix log /nix/store/jsxk8q3handkprh5ma102v8y1dig9k77-postgrest-9.0.0.drv</span><span style=color:#fbf1c7>'.
</span></pre><p>The error seems to point out that it couldn’t unpack the <code>tar</code> anywhere. Running <code>nix log /nix/store/jsxk8q3handkprh5ma102v8y1dig9k77-postgrest-9.0.0.drv</code> seems to tell me the same thing.<p>Alright alright, let’s take a look at what the manual has to say about <code>sourceRoot</code>:<blockquote><p>After running unpackPhase, the generic builder changes the current directory to the directory created by unpacking the sources. If there are multiple source directories, you should set sourceRoot to the name of the intended directory. Set sourceRoot = “.”; if you use srcs and control the unpack phase yourself.</blockquote><p>This isn’t really so helpful because I’m not using <code>srcs</code>, nor am I using <code>unpackPhase</code>, nor am I unpacking multiple sources! I am however specifying a remote file as <code>src</code> with <code>fetchurl</code>, which does seem to unpack it. I have no clue what <code>fetchurl</code> does because the manual doesn’t seem to cover it <sup class=footnote-reference><a href=#6>5</a></sup>. No idea what else to do here so I’ll just follow the suggestion of adding <code>sourceRoot "."</code>. Run <code>nix build</code> again, and see it <em>finally</em> work!<p>Here’s the final flake:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>REST API for any Postgres database</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs}: {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>defaultPackage</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>x86_64-linux </span><span style=color:#8ec07c>=
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>with </span><span style=color:#8ec07c>import </span><span style=color:#fbf1c7>nixpkgs { </span><span style=color:#fabd2f>system </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>x86_64-linux</span><span style=color:#fbf1c7>"; };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      stdenv</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkDerivation </span><span style=color:#fb4934>rec </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>name </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>postgrest-</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>version </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>9.0.0</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic># https://nixos.wiki/wiki/Packaging/Binaries
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>src </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>fetchurl {
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://github.com/PostgREST/postgrest/releases/download/v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>/postgrest-v</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>version</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>-linux-static-x64.tar.xz</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>sha256 </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>sha256-6kgh6heVV7qNcNzcXTiqbVyhfsSV9u5/S3skto6Uzz4=</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>        };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>sourceRoot </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>.</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>installPhase </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>''
</span><span style=color:#b8bb26>        install -m755 -D postgrest $out/bin/postgrest
</span><span style=color:#b8bb26>        </span><span style=color:#fbf1c7>'';
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>meta </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>with </span><span style=color:#fbf1c7>lib; {
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>homepage </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>https://postgrest.org</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>REST API for any Postgres database</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>platforms </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>platforms</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>linux;
</span><span style=color:#fbf1c7>        };
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>}
</span></pre><h2 id=importing-a-local-flake-to-another-flake><a href=#importing-a-local-flake-to-another-flake>Importing a local flake to another flake</a></h2><p>Here’s the flake file that needs <code>postgrest</code>:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>An independent MouseHunt marketplace</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>masterpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs/master</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>flake-utils</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:numtide/flake-utils</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>masterpkgs</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>flake-utils }:
</span><span style=color:#fbf1c7>    flake-utils</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>lib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>eachSystem [ "</span><span style=color:#b8bb26>x86_64-linux</span><span style=color:#fbf1c7>" ] (system:
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>let </span><span style=color:#fabd2f>pkgs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>legacyPackages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>postgrest </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>postgrestPkg</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>defaultPackage</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>lib </span><span style=color:#8ec07c>=  </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>lib;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>in </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>devShell </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkShell </span><span style=color:#fb4934>rec </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>buildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[
</span><span style=color:#fbf1c7>            masterpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>legacyPackages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>pgadmin4
</span><span style=color:#fbf1c7>          ];
</span><span style=color:#fbf1c7>        };
</span><span style=color:#fbf1c7>      });
</span><span style=color:#fbf1c7>}
</span></pre><blockquote><p>Oh, you don’t know what GNAWEX <sup class=footnote-reference><a href=#7>6</a></sup> is? Well, it’s just an app I’ve been working on for a video game I’ve been playing for nearly 12 years. I’m not addicted, I swear. I’m only doing this to learn PostgreSQL’s cool features!</blockquote><p>Besides using <code>flake-utils</code> to make handling different <code>&lt;system></code>s more convenient, the flake does look pretty much the same. Now how does one refer to this local <code>postgrest</code> flake in <em>this</em> flake? Fortunately, the wiki <sup class=footnote-reference><a href=#1>1</a></sup> has an example in the <code>inputs</code> schema section:<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># local directories (for absolute paths you can omit 'path:')
</span><span style=color:#fbf1c7>directory-example</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>url </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> "</span><span style=color:#b8bb26>path:/path/to/repo</span><span style=color:#fbf1c7>"</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p>We need to keep <code>path:</code> since we need a relative path since the <code>postgrest</code> flake is in <code>./nix/postgrest/flake.nix</code>. Add this to the flake file that needs it, in its <code>inputs</code> set:<pre style=background-color:#282828>
<span style=color:#fbf1c7>inputs </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> {
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># ...
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>postgrestPkg</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>path:./nix/postgrest</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>}</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p><code>postgrestPkg</code> can be anything, but I’m naming it <code>postgrestPkg</code> to avoid confusion with the actual <code>postgrest</code> package. Then, for convenience, I added this in the <code>let</code> expression:<pre style=background-color:#282828>
<span style=color:#fbf1c7>postgrest </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> postgrestPkg</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>defaultPackage</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span></pre><p>This binds <code>postgres-9-0-0</code> to <code>postgrest</code>, which I use in <code>devShell</code>’s <code>buildInputs</code>. Here’s the final <code>flake</code>:<pre style=background-color:#282828>
<span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>An independent MouseHunt marketplace</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>masterpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs/master</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>postgrestPkg</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>path:./nix/postgrest</span><span style=color:#fbf1c7>"; </span><span style=color:#928374;font-style:italic># New!
</span><span style=color:#fbf1c7>     </span><span style=color:#fabd2f>flake-utils</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:numtide/flake-utils</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>                                         </span><span style=color:#928374;font-style:italic># V Add this one. Order matters.
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>masterpkgs</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>postgrestPkg</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>flake-utils }:
</span><span style=color:#fbf1c7>    flake-utils</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>lib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>eachSystem [ "</span><span style=color:#b8bb26>x86_64-linux</span><span style=color:#fbf1c7>" ] (system:
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>let </span><span style=color:#fabd2f>pkgs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>legacyPackages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>postgrest </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>postgrestPkg</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>defaultPackage</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>; </span><span style=color:#928374;font-style:italic># For convenience
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>lib </span><span style=color:#8ec07c>=  </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>lib;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>in </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>devShell </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkShell </span><span style=color:#fb4934>rec </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>buildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[
</span><span style=color:#fbf1c7>            postgrest </span><span style=color:#928374;font-style:italic># A shiny `postgres` package!
</span><span style=color:#fbf1c7>            masterpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>legacyPackages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>pgadmin4
</span><span style=color:#fbf1c7>          ];
</span><span style=color:#fbf1c7>        };
</span><span style=color:#fbf1c7>      });
</span><span style=color:#fbf1c7>}
</span></pre><p>Now <code>postgrest</code> is available in the shell environment:<pre style=background-color:#282828>
<span style=color:#8ec07c>direnv:</span><span style=color:#fbf1c7> loading </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>/Projects/gnawex/.envrc
</span><span style=color:#8ec07c>direnv:</span><span style=color:#fbf1c7> using flake
</span><span style=color:#8ec07c>warning:</span><span style=color:#fbf1c7> Git tree '</span><span style=color:#b8bb26>/home/sekun/Projects/gnawex</span><span style=color:#fbf1c7>' is dirty
</span><span style=color:#8ec07c>warning:</span><span style=color:#fbf1c7> Git tree '</span><span style=color:#b8bb26>/home/sekun/Projects/gnawex</span><span style=color:#fbf1c7>' is dirty
</span><span style=color:#8ec07c>direnv:</span><span style=color:#fbf1c7> renewed cache
</span><span style=color:#8ec07c>direnv:</span><span style=color:#fbf1c7> export +AR +AS +CC +CONFIG_SHELL +CXX +DETERMINISTIC_BUILD +HOST_PATH +IN_NIX_SHELL +LD +NIX_BINTOOLS +NIX_BINTOOLS_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu +NIX_BUILD_CORES +NIX_CC +NIX_CC_WRAPPER_TARGET_HOST_x86_64_unknown_linux_gnu +NIX_CFLAGS_COMPILE +NIX_ENFORCE_NO_NATIVE +NIX_HARDENING_ENABLE +NIX_INDENT_MAKE +NIX_LDFLAGS +NIX_STORE +NM +OBJCOPY +OBJDUMP +PYTHONHASHSEED +PYTHONNOUSERSITE +PYTHONPATH +RANLIB +READELF +SIZE +SOURCE_DATE_EPOCH +STRINGS +STRIP +_PYTHON_HOST_PLATFORM +_PYTHON_SYSCONFIGDATA_NAME +buildInputs +buildPhase +builder +configureFlags +depsBuildBuild +depsBuildBuildPropagated +depsBuildTarget +depsBuildTargetPropagated +depsHostHost +depsHostHostPropagated +depsTargetTarget +depsTargetTargetPropagated +doCheck +doInstallCheck +dontAddDisableDepTrack +name +nativeBuildInputs +out +outputs +patches +phases +propagatedBuildInputs +propagatedNativeBuildInputs +shell +shellHook +stdenv +strictDeps +system </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>PATH </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>XDG_DATA_DIRS
</span><span style=color:#8ec07c>sekun@nixos </span><span style=color:#d3869b>~</span><span style=color:#fbf1c7>/P/gnawex (feature/postgrest)</span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> postgrest
</span><span style=color:#8ec07c>Usage:</span><span style=color:#fbf1c7> postgrest </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>-e|</span><span style=color:#8ec07c>--</span><span style=color:#fbf1c7>example</span><span style=color:#fb4934>] [</span><span style=color:#fbf1c7>-</span><span style=color:#8ec07c>-</span><span style=color:#fbf1c7>dump</span><span style=color:#8ec07c>-</span><span style=color:#fbf1c7>config | </span><span style=color:#8ec07c>--</span><span style=color:#fbf1c7>dump</span><span style=color:#8ec07c>-</span><span style=color:#fbf1c7>schema</span><span style=color:#fb4934>]</span><span style=color:#fbf1c7> FILENAME
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>PostgREST</span><span style=color:#fbf1c7> 9.0.0 / create a REST API to an existing Postgres database
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>Available</span><span style=color:#fbf1c7> options:
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>-h,--help</span><span style=color:#fbf1c7>                Show this help text
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>-e,--example</span><span style=color:#fbf1c7>             Show an example configuration file
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>--dump-config</span><span style=color:#fbf1c7>            Dump loaded configuration and exit
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>--dump-schema</span><span style=color:#fbf1c7>            Dump loaded schema as JSON and exit (for debugging,
</span><span style=color:#fbf1c7>                           </span><span style=color:#8ec07c>output</span><span style=color:#fbf1c7> structure is unstable)
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>FILENAME</span><span style=color:#fbf1c7>                 Path to configuration file (optional with PGRST_
</span><span style=color:#fbf1c7>                           </span><span style=color:#8ec07c>environment</span><span style=color:#fbf1c7> variables)
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>To</span><span style=color:#fbf1c7> run PostgREST, please pass the FILENAME argument or set PGRST_ environment
</span><span style=color:#8ec07c>variables.
</span></pre><p>If you’re wondering how to load the nix shell automatically without running <code>nix develop</code>, look into <code>direnv</code>, and <code>nix-direnv</code>! I’ll probably write about that too since it’s so damn handy that I can’t live without it. It’s like <code>virtualenv</code> on crack.<h2 id=conclusion><a href=#conclusion>Conclusion</a></h2><p>Could’ve been easier if everything was in the manual. But it isn’t so the entire process of figuring it out involved a lot of Google-fu + <code>man</code> + GitHub code search.<p>That’s it from me for now. It’s a relatively basic thing to do in Nix since this is in many leagues easier than building a project with it. Still useful though since there’s a <em>lot</em> of pre-built, static binaries out there.<h2 id=footnotes><a href=#footnotes>Footnotes</a></h2><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p><a href=https://nixos.wiki/wiki/Flakes>https://nixos.wiki/wiki/Flakes</a></div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p><a href=https://nixos.org/guides/nix-pills/basics-of-language.html#idm140737320525664>https://nixos.org/guides/nix-pills/basics-of-language.html#idm140737320525664</a></div><div class=footnote-definition id=3><sup class=footnote-definition-label>3</sup><p><a href=https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#flake-format>https://nixos.org/manual/nix/stable/command-ref/new-cli/nix3-flake.html#flake-format</a></div><div class=footnote-definition id=4><sup class=footnote-definition-label>4</sup><p><a href=https://nixos.wiki/wiki/Packaging/Binaries>https://nixos.wiki/wiki/Packaging/Binaries</a></div><div class=footnote-definition id=5><sup class=footnote-definition-label>7</sup><p><a href=https://nixos.org/manual/nixpkgs/stable/>https://nixos.org/manual/nixpkgs/stable/</a></div><div class=footnote-definition id=6><sup class=footnote-definition-label>5</sup><p><a href=https://github.com/NixOS/nix/issues/1489>https://github.com/NixOS/nix/issues/1489</a></div><div class=footnote-definition id=7><sup class=footnote-definition-label>6</sup><p><a href=https://github.com/gnawex/gnawex>https://github.com/gnawex/gnawex</a></div><footer><img src=/assets/images/not-by-ai.png style=width:8rem><div>Copyright <a href=https://github.com/sekunho>SEKUN</a> 2022-2025. Generated by <a href=/projects/puggle><code>puggle</code></a>.</div></footer><a href=https://mastodon.social/@sekun rel=me style=display:none>Mastodon</a><script>(function a(b){b.querySelectorAll(`template[shadowrootmode]`).forEach(b=>{const c=b.getAttribute(`shadowrootmode`);const d=b.parentNode.attachShadow({mode:c});d.appendChild(b.content);b.remove();a(d)})})(document)</script>