<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Manage secrets in NixOS - sekun</title>

    <link rel="stylesheet" href="/assets/css/style.css"/>

    <link rel="icon" href="/assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    
  <meta name="title" content="Manage secrets in NixOS" />
  <meta name="description" content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I
will probably write about in the future), and migrated some of my toy projects
from App Platform. During the migration process, I realized that I would
have to somehow handle the DB certificate, and other sensitive credentials.
I can't just hardcode these!
" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://metatags.io/" />
  <meta property="og:title" content="Manage secrets in NixOS" />
  <meta property="og:description" content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I
will probably write about in the future), and migrated some of my toy projects
from App Platform. During the migration process, I realized that I would
have to somehow handle the DB certificate, and other sensitive credentials.
I can't just hardcode these!
" />
  <meta property="og:image" content="https://sekun.net/assets/images/posts/manage-secrets-in-nixos/cover.png" />

  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://metatags.io/" />
  <meta property="twitter:title" content="Manage secrets in NixOS" />
  <meta property="twitter:description" content="Recently, I experimented with running NixOS on a DigitalOcean droplet (which I
will probably write about in the future), and migrated some of my toy projects
from App Platform. During the migration process, I realized that I would
have to somehow handle the DB certificate, and other sensitive credentials.
I can't just hardcode these!
" />
  <meta property="twitter:image" content="https://sekun.net/assets/images/posts/manage-secrets-in-nixos/cover.png" />

  </head>

  <body>
    <nav class="nav">
  <ul>
    <li><a href="/">λsekun.net</a></li>
    <li><a href="/blog">/blog</a></li>
    <li><a href="/projects">/projects</a></li>
    <li><a href="/contact">/contact</a></li>
  </ul>
</nav>
    
<h1>Manage secrets in NixOS</h1>
<div>


</div>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/manage-secrets-in-nixos/cover.png" alt="NixOS logo, and a lock icon"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<span class="post-metadata">
  Published on <time datetime="2022-10-27T12:31:00+00:00">2022-10-27 12:31 UTC</time>
</span>
<div>


  <div class="tags">
  
    <span>nixos</span>
  
    <span>agenix</span>
  
  </div>

</div>
<p>Recently, I experimented with running NixOS on a DigitalOcean droplet (which I
will probably write about in the future), and migrated some of my toy projects
from App Platform. During the migration process, I realized that I would
have to somehow handle the DB certificate, and other sensitive credentials.
I can’t just hardcode these!</p>
<p>One of the more popular projects for problems like this is
<a href="https://github.com/ryantm/agenix">agenix</a>. Their README for how to use it was
a bit confusing (for me) so hopefully this post will be of use to others.</p>
<p>There are two parts to this post: 1) creating secrets with <code>agenix</code>, and 2)
reading said secrets in a remote NixOS server. Of course you could use it for
different things, and my example isn’t exactly the simplest.</p>
<blockquote>
<p>ℹ️ I’m not saying this is the best way to do things. Please let me know
if there are any glaring issues you find!</p>
</blockquote>
<h2>Prerequisites</h2>
<p>Here’s a checklist for what’s needed:</p>
<ul>
<li><code>agenix</code> CLI present in your computer</li>
<li><code>agenix</code>’s module to the system you want secrets to be read in</li>
<li>An SSH key pair present in the machine you’ll create the secrets in as well as
in the machine you want the secrets to be read in</li>
</ul>
<p>Installing <code>agenix</code> is documented well in their README so feel free to consult
it.</p>
<h2>About <code>agenix</code></h2>
<p>Secrets are encrypted and stored by <code>agenix</code> in these things called <em>age files</em>.
These files have the <code>.age</code> format which is created by the <code>agenix</code> CLI. For
you to create an age file, the CLI looks for a <code>secrets.nix</code> file in the current
directory for the <em>rules</em> to determine who is allowed to decrypt it.</p>
<p>So, what are these rules?</p>
<p>Let’s see what the <code>agenix</code> CLI says:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> agenix
</span><span style="color:#8ec07c;">agenix</span><span style="color:#fbf1c7;"> - edit and rekey age secret files
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">agenix</span><span style="color:#fbf1c7;"> -e FILE </span><span style="color:#fb4934;">[</span><span style="color:#fbf1c7;">-i PRIVATE_KEY</span><span style="color:#fb4934;">]
</span><span style="color:#8ec07c;">agenix</span><span style="color:#fbf1c7;"> -r </span><span style="color:#fb4934;">[</span><span style="color:#fbf1c7;">-i PRIVATE_KEY</span><span style="color:#fb4934;">]
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">options:
</span><span style="color:#8ec07c;">-h,</span><span style="color:#fbf1c7;"> --help                show help
</span><span style="color:#8ec07c;">-e,</span><span style="color:#fbf1c7;"> --edit FILE           edits FILE using </span><span style="color:#458588;">$</span><span style="color:#83a598;">EDITOR
</span><span style="color:#8ec07c;">-r,</span><span style="color:#fbf1c7;"> --rekey               re-encrypts all secrets with specified recipients
</span><span style="color:#8ec07c;">-i,</span><span style="color:#fbf1c7;"> --identity            identity to use when decrypting
</span><span style="color:#8ec07c;">-v,</span><span style="color:#fbf1c7;"> --verbose             verbose output
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">FILE</span><span style="color:#fbf1c7;"> an age-encrypted file
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">PRIVATE_KEY</span><span style="color:#fbf1c7;"> a path to a private SSH key used to decrypt file
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">EDITOR</span><span style="color:#fbf1c7;"> environment variable of editor to use when editing FILE
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">RULES</span><span style="color:#fbf1c7;"> environment variable with path to Nix file specifying recipient public keys.
</span><span style="color:#8ec07c;">Defaults</span><span style="color:#fbf1c7;"> to &#39;</span><span style="color:#b8bb26;">./secrets.nix</span><span style="color:#fbf1c7;">&#39;
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">agenix</span><span style="color:#fbf1c7;"> version: 0.13.0
</span><span style="color:#8ec07c;">age</span><span style="color:#fbf1c7;"> binary path: /nix/store/kfasn0129ac0xn8wfvf7mq38rxhbc725-rage-0.8.1/bin/rage
</span><span style="color:#8ec07c;">age</span><span style="color:#fbf1c7;"> version: rage 0.8.1
</span></pre>
<p>Specifically:</p>
<blockquote>
<p>RULES environment variable with path to Nix file specifying recipient public keys.
Defaults to ‘./secrets.nix’</p>
</blockquote>
<p>In the aforementioned file, we’re able to say whose key can decrypt what age file.
Let’s create this file first.</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;"># We&#39;ll store the rules, and age files in the `secrets` folder
</span><span style="color:#8ec07c;">mkdir</span><span style="color:#fbf1c7;"> secrets
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">touch</span><span style="color:#fbf1c7;"> secrets.nix
</span></pre>
<p>For the example later, I’ll need two files: one containing the DB CA certificate,
and the DB password. So I’ll create a rule for each age file I’m going to generate
later on.</p>
<p>Here’s how it looks like:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;"># secrets/secrets.nix
</span><span style="color:#fbf1c7;">
</span><span style="color:#fb4934;">let
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">peepeepoopoo </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIB/Oxx/jZS7TRqjp2kwaYavzcxxKFTrStikFrtZq3q3l root@peepeepoopoo</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fb4934;">in </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">emojiedDBPassword.age</span><span style="color:#fbf1c7;">&quot;.</span><span style="color:#fabd2f;">publicKeys </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ peepeepoopoo ];
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">emojiedDBCACert.age</span><span style="color:#fbf1c7;">&quot;.</span><span style="color:#fabd2f;">publicKeys </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ peepeepoopoo ];
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>When decrypting/creating <code>emojiedDBPassword.age</code> for example, <code>agenix</code> looks for
the private key pair of the public key that was supplied. Otherwise, it prohibits
the user from doing so, and will complain about there not being any matching keys.</p>
<blockquote>
<p>ℹ️ You don’t need the rules file for decrypting an age file because the
permissions are already encoded in the age file. You should only have it present
if you’re using the CLI for creating/updating an age file.</p>
</blockquote>
<p>We’ll need the <code>agenix</code> CLI to create an age file containing our encrypted secret,
and run this:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> agenix -e emojiedDBCACert.age
</span></pre>
<p>This opens a text editor for you to put the secret in.</p>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/manage-secrets-in-nixos/agenix-edit.png" alt="Screenshot of a text editor showing the secret censored"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<p>If you need to add public keys for existing age files, update the <code>secrets.nix</code>
file accordingly, and run <code>agenix -r</code>. Make sure you’re in the same directory
as the <code>secrets.nix</code>, and age files.</p>
<p>It would show you something like this if it succeeds:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> agenix -r
</span><span style="color:#8ec07c;">rekeying</span><span style="color:#fbf1c7;"> emojiedDBCACert.age...
</span><span style="color:#8ec07c;">rekeying</span><span style="color:#fbf1c7;"> emojiedDBPassword.age...
</span></pre>
<p>Now our age files are ready to be used!</p>
<p>I mentioned earlier that my use case is for supplying the DB CA certificate, and
DB password to the <a href="https://emojied.net"><code>emojied</code></a> app for it to connect with
the DB properly. I won’t get into the details of how I set up the server. Rather,
I’ll just include the parts necessary. If you wish to read the full config files,
check the <a href="https://github.com/sekunho/dotfiles">repo</a> although <code>peepeepoopoo</code> here
is a throwaway server. Hence not in the repo.</p>
<p>What I need in the remote server called <code>peepeepoopoo</code> (where <code>emojied</code> is
running) are the ff:</p>
<ul>
<li><code>agenix</code> NixOS module</li>
<li>Age files</li>
<li>SSH key permitted to decrypt said age files</li>
</ul>
<p><code>flake.nix</code>:</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">description </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">Example</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">inputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">nixpkgs</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:NixOS/nixpkgs/nixos-22.05</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">emojiedpkg</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:sekunho/emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">agenix</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:ryantm/agenix</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">outputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    self</span><span style="color:#8ec07c;">,
</span><span style="color:#fbf1c7;">    nixpkgs</span><span style="color:#8ec07c;">,
</span><span style="color:#fbf1c7;">    emojiedpkg</span><span style="color:#8ec07c;">,
</span><span style="color:#fbf1c7;">    agenix
</span><span style="color:#fbf1c7;">  }:
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">let
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">system </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">x86_64-linux</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">pkgs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">legacyPackages</span><span style="color:#8ec07c;">.</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">emojiedpkg</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">in </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">nixosConfigurations</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">peepeepoopoo </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nixosSystem {
</span><span style="color:#fbf1c7;">        </span><span style="color:#fb4934;">inherit </span><span style="color:#fabd2f;">system</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">modules </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[
</span><span style="color:#fbf1c7;">          emojiedpkg</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nixosModule
</span><span style="color:#fbf1c7;">          </span><span style="color:#b8bb26;">./hosts/peepeepoopoo/configuration.nix
</span><span style="color:#fbf1c7;">          agenix</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nixosModules</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">age
</span><span style="color:#fbf1c7;">        ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="font-style:italic;color:#928374;"># Applies the configuration.nix function to these arguments
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">specialArgs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">          </span><span style="color:#fb4934;">inherit </span><span style="color:#fabd2f;">pkgs</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">          </span><span style="color:#fb4934;">inherit </span><span style="color:#fabd2f;">emojied</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">        };
</span><span style="color:#fbf1c7;">      };
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>All that’s left to do is specify where the age files are located, and referencing
the decrypted age files’ paths.</p>
<p><code>hosts/peepeepoopoo/configuration.nix</code>:</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">{ modulesPath</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">config</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">, ... </span><span style="color:#fbf1c7;">}: {
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">imports </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">optional (</span><span style="color:#d3869b;">builtins</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">pathExists </span><span style="color:#b8bb26;">./do-userdata.nix</span><span style="color:#fbf1c7;">) </span><span style="color:#b8bb26;">./do-userdata.nix </span><span style="color:#8ec07c;">++ </span><span style="color:#fbf1c7;">[
</span><span style="color:#fbf1c7;">    (modulesPath </span><span style="color:#8ec07c;">+ </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">/virtualisation/digital-ocean-config.nix</span><span style="color:#fbf1c7;">&quot;)
</span><span style="color:#fbf1c7;">  ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">programs</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">ssh </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">startAgent </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">true</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">extraConfig </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">      AddKeysToAgent yes
</span><span style="color:#b8bb26;">    </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">nix </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">package </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nixVersions</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nix_2_9;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">extraOptions </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">      experimental-features = nix-command flakes
</span><span style="color:#b8bb26;">    </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">settings</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">trusted-public-keys </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">hydra.iohk.io:f/Ea+s+dFdN+3Y/G+FDgSq+a5NEWhJGzdjvKNGv0/EQ=</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">iohk.cachix.org-1:DpRUyj7h7V830dp/i6Nti+NEO2/nhblbov/8MW7Rqoo=</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs=</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">    ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">settings</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">substituters </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">https://cache.iog.io</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">https://iohk.cachix.org</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">https://nix-community.cachix.org</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">    ];
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">age </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># We&#39;re letting `agenix` know where the locations of the age files will be
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># in the server.
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">secrets </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">emojiedDBPassword</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">file </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">/root/secrets/emojiedDBPassword.age</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">emojiedDBCACert</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">file </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">/root/secrets/emojiedDBCACert.age</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># Private key of the SSH key pair. This is the other pair of what was supplied
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># in `secrets.nix`.
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;">#
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># This tells `agenix` where to look for the private key.
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">identityPaths </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ &quot;</span><span style="color:#b8bb26;">/root/.ssh/id_ed25519</span><span style="color:#fbf1c7;">&quot; ];
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># List services that you want to enable:
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">services </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">enable </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">true</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">port </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">3000</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbHost </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">&lt;REPLACE_WITH_YOUR_OWN&gt;</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbName </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">&lt;REPLACE_WITH_YOUR_OWN&gt;</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbPort </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">&lt;REPLACE_WITH_YOUR_OWN&gt;</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbUser </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">&lt;REPLACE_WITH_YOUR_OWN&gt;</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbPoolSize </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">5</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbPasswordFile </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">config</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">age</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">secrets</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojiedDBPassword</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">path;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">dbCACertFile </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">config</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">age</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">secrets</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojiedDBCACert</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">path;
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">openssh </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">enable </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">true</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">permitRootLogin </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">prohibit-password</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">passwordAuthentication </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">false</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">networking </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">firewall </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">enable </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">true</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">      </span><span style="color:#fabd2f;">allowedTCPPorts </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ </span><span style="color:#d3869b;">22 3000 </span><span style="color:#fbf1c7;">];
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># List packages installed in system profile. To search, run:
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># $ nix search wget
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">environment </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">systemPackages </span><span style="color:#8ec07c;">= </span><span style="color:#fb4934;">with </span><span style="color:#fbf1c7;">pkgs; [];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">loginShellInit </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">      export SSH_AUTH_SOCK=&quot;$XDG_RUNTIME_DIR/ssh-agent.socket&quot;
</span><span style="color:#b8bb26;">    </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">system</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">stateVersion </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">22.05</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>Now we can move the <code>secrets</code> folder, and the SSH key (if it’s not already there)
from our host machine to the remote server.</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> scp secrets root@</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">SERVER_IP</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">:/root/
</span><span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> scp </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/.ssh/</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">YOUR_KEY</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> root@</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">SERVER_IP</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">:/root/.ssh/id_ed25519
</span><span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> scp </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/.ssh/</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">YOUR_KEY</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">.pub root@</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">SERVER_IP</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">:/root/.ssh/id_ed25519.pub
</span></pre>
<p>Then hit build and apply the config:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">$</span><span style="color:#fbf1c7;"> nixos-rebuild switch \
</span><span style="color:#fbf1c7;">  --flake .#peepeepoopoo \
</span><span style="color:#fbf1c7;">  --target-host root@</span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;">SERVER_IP</span><span style="color:#8ec07c;">&gt; </span><span style="color:#fbf1c7;">\
</span><span style="color:#fbf1c7;">  --build-host localhost
</span><span style="color:#8ec07c;">copying</span><span style="color:#fbf1c7;"> 3 paths...
</span><span style="color:#8ec07c;">copying</span><span style="color:#fbf1c7;"> path &#39;</span><span style="color:#b8bb26;">/nix/store/lali119kww58c4df3b1w61yzg5an1mr7-system-units</span><span style="color:#fbf1c7;">&#39; to &#39;</span><span style="color:#b8bb26;">ssh://root@&lt;SERVER_IP&gt;</span><span style="color:#fbf1c7;">&#39;...
</span><span style="color:#8ec07c;">copying</span><span style="color:#fbf1c7;"> path &#39;</span><span style="color:#b8bb26;">/nix/store/g1izspgbn34hmlll2hby5qapx90nm43p-etc</span><span style="color:#fbf1c7;">&#39; to &#39;</span><span style="color:#b8bb26;">ssh://root@&lt;SERVER_IP&gt;</span><span style="color:#fbf1c7;">&#39;...
</span><span style="color:#8ec07c;">copying</span><span style="color:#fbf1c7;"> path &#39;</span><span style="color:#b8bb26;">/nix/store/739zphavd4d1vjfnd8v2b1bpm0dzwxz6-nixos-system-unnamed-22.05.20221024.6107f97</span><span style="color:#fbf1c7;">&#39; to &#39;</span><span style="color:#b8bb26;">ssh://root@&lt;SERVER_IP&gt;</span><span style="color:#fbf1c7;">&#39;...
</span><span style="color:#8ec07c;">updating</span><span style="color:#fbf1c7;"> GRUB 2 menu...
</span><span style="color:#8ec07c;">stopping</span><span style="color:#fbf1c7;"> the following units: emojied.service
</span><span style="color:#8ec07c;">activating</span><span style="color:#fbf1c7;"> the configuration...
</span><span style="color:#8ec07c;">[agenix]</span><span style="color:#fbf1c7;"> creating new generation in /run/agenix.d/1
</span><span style="color:#8ec07c;">[agenix]</span><span style="color:#fbf1c7;"> decrypting secrets...
</span><span style="color:#8ec07c;">decrypting </span><span style="color:#fbf1c7;">&#39;</span><span style="color:#b8bb26;">/root/secrets/emojiedDBCACert.age</span><span style="color:#fbf1c7;">&#39; to &#39;</span><span style="color:#b8bb26;">/run/agenix.d/1/emojiedDBCACert</span><span style="color:#fbf1c7;">&#39;...
</span><span style="color:#8ec07c;">decrypting </span><span style="color:#fbf1c7;">&#39;</span><span style="color:#b8bb26;">/root/secrets/emojiedDBPassword.age</span><span style="color:#fbf1c7;">&#39; to &#39;</span><span style="color:#b8bb26;">/run/agenix.d/1/emojiedDBPassword</span><span style="color:#fbf1c7;">&#39;...
</span><span style="color:#8ec07c;">[agenix]</span><span style="color:#fbf1c7;"> symlinking new secrets to /run/agenix (generation 1)</span><span style="color:#8ec07c;">...
</span><span style="color:#8ec07c;">[agenix]</span><span style="color:#fbf1c7;"> chowning...
</span><span style="color:#8ec07c;">setting</span><span style="color:#fbf1c7;"> up /etc...
</span><span style="color:#8ec07c;">reloading</span><span style="color:#fbf1c7;"> user units for root...
</span><span style="color:#8ec07c;">setting</span><span style="color:#fbf1c7;"> up tmpfiles
</span><span style="color:#8ec07c;">starting</span><span style="color:#fbf1c7;"> the following units: emojied.service
</span><span style="color:#8ec07c;">the</span><span style="color:#fbf1c7;"> following new units were started: run-agenix.d.mount
</span></pre>
<p>Which gives me this beautiful creation:</p>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/manage-secrets-in-nixos/emojied-leaderboard.png" alt="Screenshot of emojied.net's leaderboard"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>


    <footer>
  <img style="width: 8rem;" src="/assets/images/not-by-ai.png">
  <div>
    Copyright <a href="https://github.com/sekunho">SEKUN</a> 2022-2025.
    Generated by <a href="/projects/puggle"><code>puggle</code></a>.
  </div>
</footer>

    <a rel="me" href="https://mastodon.social/@sekun" style="display: none;">Mastodon</a>
    <script>
      (function attachShadowRoots(root) {
        root.querySelectorAll("template[shadowrootmode]").forEach(template => {
          const mode = template.getAttribute("shadowrootmode");
          const shadowRoot = template.parentNode.attachShadow({ mode });

          shadowRoot.appendChild(template.content);
          template.remove();
          attachShadowRoots(shadowRoot);
        });
      })(document);
    </script>
  </body>
</html>