<!doctype html><html lang=en><title>Deploying Nix builds on Fly.io - sekun</title><link href=/assets/css/style.css rel=stylesheet><link href=/assets/images/favicon.ico rel=icon><link href=/assets/images/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/assets/images/apple-touch-icon.png rel=apple-touch-icon><link href=/assets/images/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/assets/images/safari-pinned-tab.svg rel=mask-icon><meta content="width=device-width,initial-scale=1.0" name=viewport><meta charset=UTF-8><meta content="Deploying Nix builds on Fly.io" name=title><meta content="The current approach Fly.io recommends doing is you write a Dockerfile to
build, and run your app on their platform. However, if you've already packaged
your application with nix, it would be nice to capitalize on that, and
throw it into a docker image somehow instead of having to create a
separate build process.
" name=description><meta content=website property=og:type><meta content=https://metatags.io/ property=og:url><meta content="Deploying Nix builds on Fly.io" property=og:title><meta content="The current approach Fly.io recommends doing is you write a Dockerfile to
build, and run your app on their platform. However, if you've already packaged
your application with nix, it would be nice to capitalize on that, and
throw it into a docker image somehow instead of having to create a
separate build process.
" property=og:description><meta content=https://sekun.net/assets/images/posts/deploying-nix-builds-to-fly-io/cover.jpg property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://metatags.io/ property=twitter:url><meta content="Deploying Nix builds on Fly.io" property=twitter:title><meta content="The current approach Fly.io recommends doing is you write a Dockerfile to
build, and run your app on their platform. However, if you've already packaged
your application with nix, it would be nice to capitalize on that, and
throw it into a docker image somehow instead of having to create a
separate build process.
" property=twitter:description><meta content=https://sekun.net/assets/images/posts/deploying-nix-builds-to-fly-io/cover.jpg property=twitter:image><body><nav class=nav><ul><li><a href=/>λsekun.net</a><li><a href=/blog>/blog</a><li><a href=/projects>/projects</a><li><a href=/contact>/contact</a></ul></nav><h1 id="Deploying Nix builds on Fly.io"><a href="#Deploying Nix builds on Fly.io">Deploying Nix builds on Fly.io</a></h1><div></div><div><x-img> <template shadowrootmode=open><img alt="Fly.io, and NixOS logos shaking hands" src=/assets/images/posts/deploying-nix-builds-to-fly-io/cover.jpg> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><span class=post-metadata> Published on <time datetime=2024-10-18T14:48:52+00:00>2024-10-18 14:48 UTC</time> </span><div><div class=tags><span>nix</span><span>fly.io</span></div></div><p><em>In 9 days it would’ve been 2 years since I last posted. Wow time does… <strong>Fly</strong></em>.<p>Around a month ago, I was messing around with <a href=https://fly.io>Fly.io</a> + <code>nix</code> for a toy project, and <a href=https://twitter.com/sekunho_/status/1835016387133350146>tweeted</a> about the experience. There I was asked by <a href=https://twitter.com/GemmaBlackUK>@GemmaBlackUK</a> if I had written an article about it, and thought well maybe it would make a nice article to start with after years of ignoring this blog. So here’s a debut article for my new blog engine (that I may rewrite yet again in a year).<hr><p>The current approach Fly.io recommends doing is you write a <code>Dockerfile</code> to build, and run your app on their platform. However, if you’ve already packaged your application with <code>nix</code>, it would be nice to capitalize on that, and throw it into a docker image somehow instead of having to create a separate build process. This means reusing the exact tooling present in your nix dev shell down to the exact commit.<p>But do not fret, you <em>can</em> do something like that! Just with slightly more work.<h2 id=prerequisites><a href=#prerequisites>Prerequisites</a></h2><p>You’ll need to have the following installed:<ul><li><code>nix</code> with flakes enabled</ul><p>The rest of the tools needed will be supplied by <code>nix</code> in a dev shell we’ll make.<p>To start everything off, let’s make a <code>flake.nix</code> by running <code>nix flake init</code> in your directory of choice. This generates the file with the following:<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># flake.nix
</span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>description </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>A very basic flake</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:nixos/nixpkgs?ref=nixos-unstable</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs }: {
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic># NOTE: You can delete this
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>packages</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>x86_64-linux</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>hello </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>legacyPackages</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>x86_64-linux</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>hello;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic># NOTE: and this because we don't need them
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>packages</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>x86_64-linux</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>default </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>self</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>packages</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>x86_64-linux</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>hello;
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>}
</span></pre><p>The application that’s gonna run in the image is one that reads an environment variable <code>APP_ECHO_ME</code>, and renders it into an HTML page served by <code>axum</code>. The environment will be set through Fly secrets.<blockquote><p>You can find it in this <a href=https://github.com/sekunho/webecho>GitHub repository</a>. Though if you have one to already tinker with, feel free to skip to the next section.</blockquote><p>The gist of it is <code>webecho</code> looks for the environment variable <code>APP_ECHO_ME</code>, and renders it into an HTML page that’s served by axum.<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic>// main.rs
</span><span style=color:#fb4934>use </span><span style=color:#fbf1c7>axum::{response::Html, routing, Router};
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>#[</span><span style=color:#83a598>tokio</span><span style=color:#fbf1c7>::</span><span style=color:#83a598>main</span><span style=color:#fbf1c7>]
</span><span style=color:#fbf1c7>async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>main</span><span style=color:#fbf1c7>() {
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>// please dkm for unwraps
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new().</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/echo</span><span style=color:#fbf1c7>", routing::get(echo));
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> listener </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>tokio::net::TcpListener::bind("</span><span style=color:#b8bb26>0.0.0.0:8080</span><span style=color:#fbf1c7>").await.</span><span style=color:#8ec07c>unwrap</span><span style=color:#fbf1c7>();
</span><span style=color:#fbf1c7>    axum::serve(listener, app).await.</span><span style=color:#8ec07c>unwrap</span><span style=color:#fbf1c7>();
</span><span style=color:#fbf1c7>}
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>echo</span><span style=color:#fbf1c7>() -> Html&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>match </span><span style=color:#fbf1c7>std::env::var("</span><span style=color:#b8bb26>APP_ECHO_ME</span><span style=color:#fbf1c7>") {
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(val) </span><span style=color:#8ec07c>=></span><span style=color:#fbf1c7> Html(format!("</span><span style=color:#b8bb26>&lt;h1></span><span style=color:#8ec07c>{val}</span><span style=color:#b8bb26>&lt;/h1></span><span style=color:#fbf1c7>")),
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Err</span><span style=color:#fbf1c7>(</span><span style=color:#8ec07c>_</span><span style=color:#fbf1c7>) </span><span style=color:#8ec07c>=></span><span style=color:#fbf1c7> Html(format!("</span><span style=color:#b8bb26>bruh</span><span style=color:#fbf1c7>")),
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>}
</span></pre><p>Which we packaged with <code>nix</code> like so<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># flake.nix
</span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>inputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic># We set the nix packages repo to the latest stable (at the time of writing)
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:NixOS/nixpkgs/nixos-24.05</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic># Used for packaging rust applications
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>crane</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:ipetkov/crane</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic># Used for setting up rust toolchain
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>fenix </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>url </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>github:nix-community/fenix</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>inputs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>nixpkgs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>follows </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>nixpkgs</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>inputs</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>rust-analyzer-src</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>follows </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"";
</span><span style=color:#fbf1c7>    };
</span><span style=color:#fbf1c7>  };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>outputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ self</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>nixpkgs</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>crane</span><span style=color:#8ec07c>, </span><span style=color:#fbf1c7>fenix }:
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>system </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>x86_64-linux</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>pkgs </span><span style=color:#8ec07c>= import </span><span style=color:#fbf1c7>nixpkgs { </span><span style=color:#fb4934>inherit </span><span style=color:#fabd2f>system</span><span style=color:#fbf1c7>; };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#928374;font-style:italic># We're telling crane about the rust toolchain we want to use
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>craneLib </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>(crane</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkLib pkgs)</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>overrideToolchain
</span><span style=color:#fbf1c7>        fenix</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>packages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>stable</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>toolchain;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#928374;font-style:italic># Project source for crane to look in
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>src </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>lib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>cleanSourceWith {
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>src </span><span style=color:#8ec07c>= </span><span style=color:#b8bb26>./.</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>filter </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>path: type:
</span><span style=color:#fbf1c7>          (craneLib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>filterCargoSources path type)
</span><span style=color:#fbf1c7>        ;
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>commonArgs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>inherit </span><span style=color:#fabd2f>src</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>version </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>0.1.0</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>strictDeps </span><span style=color:#8ec07c>= </span><span style=color:#d3869b>true</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>pname </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>webecho</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>name </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>webecho</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>buildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[ ];
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>nativeBuildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[ ];
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>cargoArtifacts </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>craneLib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>buildDepsOnly commonArgs;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>webecho </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>craneLib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>buildPackage (commonArgs </span><span style=color:#8ec07c>// </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>inherit </span><span style=color:#fabd2f>cargoArtifacts</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>doCheck </span><span style=color:#8ec07c>= </span><span style=color:#d3869b>false</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>CARGO_PROFILE </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>release</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      });
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>in
</span><span style=color:#fbf1c7>    {
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>packages</span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>} </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ </span><span style=color:#fb4934>inherit </span><span style=color:#fabd2f>webecho</span><span style=color:#fbf1c7>; };
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#928374;font-style:italic># `nixpkgs-fmt`, and `nil` are optional. They're just helpful for working
</span><span style=color:#fbf1c7>      </span><span style=color:#928374;font-style:italic># with nix source files. Though `dive`, and `flyctl` are tools used in this
</span><span style=color:#fbf1c7>      </span><span style=color:#928374;font-style:italic># article.
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>devShells</span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#fbf1c7>.</span><span style=color:#fabd2f>default </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>craneLib</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>devShell {
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>packages </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>with </span><span style=color:#fbf1c7>pkgs; [ nixpkgs-fmt nil dive flyctl ];
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>    };
</span><span style=color:#fbf1c7>}
</span></pre><p>We can run <code>webecho</code> with <code>nix run .#webecho</code>, and then visit <code>http://localhost:8080/echo</code>.<div><x-img> <template shadowrootmode=open><img alt src=/assets/images/posts/deploying-nix-builds-to-fly-io/webecho_bruh.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><p>and <code>APP_ECHO_ME="nix fixes this" nix run .#webecho</code><div><x-figure> <template shadowrootmode=open><figure><img alt src=/assets/images/posts/deploying-nix-builds-to-fly-io/webecho_nix_fixes_this.png><figcaption><slot></slot></figcaption></figure> <style>figure{margin:1.5rem auto;display:block;& img{width:100%}& figcaption{text-align:center;color:#a89984;font-style:italic}}</style></template> now you sound like the average nixos user on twitter dot com </x-figure></div><h2 id=building-the-container-image-with-nix><a href=#building-the-container-image-with-nix>Building the container image with nix</a></h2><p><code>nix</code> has a few options for creating images<sup class=footnote-reference><a href=#1>1</a></sup> but the one we’ll be using is <code>pkgs.streamLayeredImage</code><sup class=footnote-reference><a href=#2>2</a></sup>. It has a bunch of attributes in it but we’re only interested in a couple of them.<p>Let’s define a new binding <code>webechoImg</code> that’s going to be our container image:<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># flake.nix
</span><span style=color:#fb4934>let
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># previous let..in bindings
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>webechoImg </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>streamLayeredImage {
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>name </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>webecho</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>tag </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>latest</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>contents </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[ self</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>packages</span><span style=color:#8ec07c>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>webecho ];
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>config </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Cmd </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>[ "</span><span style=color:#b8bb26>/bin/webecho</span><span style=color:#fbf1c7>" ];
</span><span style=color:#fbf1c7>      };
</span><span style=color:#fbf1c7>  }
</span><span style=color:#fbf1c7;background-color:#fb4934>in</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic># snip
</span></pre><p>So the NixOS manual says this about the <code>contents</code> attribute:<blockquote><p>Directories whose contents will be added to the generated image. Things that coerce to paths (e.g. a derivation) can also be used. This can be seen as an equivalent of <code>ADD contents/ /</code> in a Dockerfile.<p>All the contents specified by contents will be added as a final layer in the generated image. They will be added as links to the actual files (e.g. links to the store paths). The actual files will be added in previous layers.</blockquote><p>Which is something we want for our <code>webecho</code> application since it’s what gets executed when the container runs.<p>Now we add a new binding to <code>packages</code>:<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># flake.nix
</span><span style=color:#928374;font-style:italic># ... snip
</span><span style=color:#fbf1c7;background-color:#fb4934>in</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>  </span><span style=color:#fabd2f>packages</span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>system</span><span style=color:#8ec07c;font-style:italic>} </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>{ </span><span style=color:#fb4934>inherit </span><span style=color:#fabd2f>webecho webechoImg</span><span style=color:#fbf1c7>; };
</span><span style=color:#928374;font-style:italic># ... snip
</span></pre><blockquote><p><code>inherit webecho;</code> is a shorthand for <code>webecho = webecho;</code>. If the name is the same, it can be useful for chaining a bunch of bindings instead of having to manually name, and bind values to it.</blockquote><p>and like <code>webecho</code>, this can be built like so:<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> nix build .#webechoImg
</span></pre><p>The generated image is stored in a <code>tar</code> file named as <code>result</code> which we have To load into <code>docker</code> as an image.<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> ./result </span><span style=color:#8ec07c>| docker</span><span style=color:#fbf1c7> image load
</span><span style=color:#8ec07c>No </span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>fromImage</span><span style=color:#fbf1c7>' provided
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 1 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/zvwpisszhpkkk8spqyya8n3bpm7wj39p-libunistring-1.1</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 2 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/9jivp79yv91fl1i6ayq2107a78q7k43i-libidn2-2.3.7</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 3 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/2y852kcvb7shrj8f3z8j22pa0iybcbgj-xgcc-13.2.0-libgcc</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 4 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/c10zhkbp6jmyh0xc5kd123ga8yy2p4hk-glibc-2.39-52</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 5 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/yfd49ay99aa1a0jg80jsvnxbyl61fsh6-gcc-13.2.0-libgcc</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 6 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/swcl0ynnia5c57i6qfdcrqa72j7877mg-gcc-13.2.0-lib</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 7 from paths: </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>'</span><span style=color:#b8bb26>/nix/store/5w470zmki3wby35ki8ql3xhrd8x450lf-webecho</span><span style=color:#fbf1c7>'</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>Creating</span><span style=color:#fbf1c7> layer 8 with customisation...
</span><span style=color:#8ec07c>Adding</span><span style=color:#fbf1c7> manifests...
</span><span style=color:#8ec07c>Done.
</span><span style=color:#8ec07c>14d9ed21e5fa:</span><span style=color:#fbf1c7> Loading layer </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>==================================================></span><span style=color:#fb4934>]</span><span style=color:#fbf1c7>    983kB/983kB
</span><span style=color:#8ec07c>18dc56492fda:</span><span style=color:#fbf1c7> Loading layer </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>==================================================></span><span style=color:#fb4934>]</span><span style=color:#fbf1c7>  10.24kB/10.24kB
</span><span style=color:#8ec07c>The</span><span style=color:#fbf1c7> image webecho:latest already exists, renaming the old one with ID sha256:71901dfab2e5a591cf264891021db0bc258927788db5786f18fbbb8835fc6b5e to empty string
</span><span style=color:#8ec07c>Loaded</span><span style=color:#fbf1c7> image: webecho:latest
</span></pre><p>You can look around the image with <code>dive webecho:latest</code>.<div><x-img> <template shadowrootmode=open><img alt src=/assets/images/posts/deploying-nix-builds-to-fly-io/webecho_dive.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><p>Then you can run this image as if it were any other image created from a <code>Dockerfile</code>!<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> docker run -p 8080:8080 webecho:latest
</span></pre><p>And when we try to <code>curl</code> it<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> curl http://localhost:8080/echo
</span><span style=color:#8ec07c>bruh⏎
</span></pre><p>So far looks pretty good.<h2 id=deploying-to-fly.io><a href=#deploying-to-fly.io>Deploying to Fly.io</a></h2><p>This part shouldn’t differ too much from the usual deployment process.<p>First, login your Fly account with <a href=https://fly.io/docs/flyctl/auth-login/><code>flyctl auth login</code></a>. This opens a new tab in your browser for you to complete the login process.<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> fly auth login
</span><span style=color:#8ec07c>$</span><span style=color:#fbf1c7> fly auth docker </span><span style=color:#928374;font-style:italic># authenticates your local docker to push to their container registry
</span><span style=color:#8ec07c>$</span><span style=color:#fbf1c7> fly apps create webecho </span><span style=color:#928374;font-style:italic># create an application called webecho under your account
</span></pre><p>Then we need to tag the image to something that Fly.io expects which is in the format of <code>registry.fly.io/&lt;APP_NAME>:&lt;VERSION></code>, and push it to their registry.<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> docker image tag webecho:latest registry.fly.io/webecho:latest
</span><span style=color:#8ec07c>$</span><span style=color:#fbf1c7> docker push registry.fly.io/webecho:latest
</span><span style=color:#8ec07c>The</span><span style=color:#fbf1c7> push refers to repository </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>registry.fly.io/webecho</span><span style=color:#fb4934>]
</span><span style=color:#8ec07c>18dc56492fda:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>14d9ed21e5fa:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>f958be77db0f:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>5a95ac30ae8b:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>0dbac4a9743c:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>6b971f7d0a50:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>905fa559f035:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>975a8857676b:</span><span style=color:#fbf1c7> Pushed
</span><span style=color:#8ec07c>latest:</span><span style=color:#fbf1c7> digest: </span><span style=color:#8ec07c>&lt;</span><span style=color:#fbf1c7>SHA265 OMITTED</span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> size: 1995
</span></pre><p>Finally, we create the <code>fly.toml</code> file<pre style=background-color:#282828>
<span style=color:#928374;font-style:italic># fly.toml
</span><span style=color:#83a598>app </span><span style=color:#fbf1c7>= '</span><span style=color:#b8bb26>webecho</span><span style=color:#fbf1c7>'
</span><span style=color:#83a598>primary_region </span><span style=color:#fbf1c7>= '</span><span style=color:#b8bb26>sea</span><span style=color:#fbf1c7>'
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>[build]
</span><span style=color:#83a598>image </span><span style=color:#fbf1c7>= '</span><span style=color:#b8bb26>registry.fly.io/webecho:latest</span><span style=color:#fbf1c7>'
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>[deploy]
</span><span style=color:#83a598>strategy </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>rolling</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>[http_service]
</span><span style=color:#83a598>internal_port </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>8080
</span><span style=color:#83a598>force_https </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>true
</span><span style=color:#83a598>auto_stop_machines </span><span style=color:#fbf1c7>= '</span><span style=color:#b8bb26>stop</span><span style=color:#fbf1c7>'
</span><span style=color:#83a598>auto_start_machines </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>true
</span><span style=color:#83a598>min_machines_running </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>1
</span><span style=color:#83a598>processes </span><span style=color:#fbf1c7>= ['</span><span style=color:#b8bb26>app</span><span style=color:#fbf1c7>']
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>[[vm]]
</span><span style=color:#83a598>size </span><span style=color:#fbf1c7>= '</span><span style=color:#b8bb26>shared-cpu-1x</span><span style=color:#fbf1c7>'
</span><span style=color:#83a598>memory </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>256mb</span><span style=color:#fbf1c7>"
</span><span style=color:#83a598>cpus </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>1
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>[checks.health]
</span><span style=color:#83a598>type </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>http</span><span style=color:#fbf1c7>"
</span><span style=color:#83a598>method </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>GET</span><span style=color:#fbf1c7>"
</span><span style=color:#83a598>path </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>/echo</span><span style=color:#fbf1c7>"
</span><span style=color:#83a598>port </span><span style=color:#fbf1c7>= </span><span style=color:#d3869b>8080
</span><span style=color:#83a598>interval </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>5s</span><span style=color:#fbf1c7>"
</span><span style=color:#83a598>timeout </span><span style=color:#fbf1c7>= "</span><span style=color:#b8bb26>5s</span><span style=color:#fbf1c7>"
</span></pre><p>And deploy!<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> flyctl deploy -c fly.toml -a webecho
</span></pre><div><x-img> <template shadowrootmode=open><img alt src=/assets/images/posts/deploying-nix-builds-to-fly-io/webecho_bruh_on_fly.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><blockquote><p>Your app’s URL will vary depending on what they give you. Check your app’s dashboard just to be sure.</blockquote><p>Right. Forgot to set the environment variable!<pre style=background-color:#282828>
<span style=color:#8ec07c>$</span><span style=color:#fbf1c7> fly secrets set "</span><span style=color:#b8bb26>APP_ECHO_ME=nix fixes this</span><span style=color:#fbf1c7>" -c fly.toml -a webecho
</span></pre><div><x-img> <template shadowrootmode=open><img alt src=/assets/images/posts/deploying-nix-builds-to-fly-io/webecho_nix_fixes_this_on_fly.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><blockquote><p>If you would like to check out the final result of everything in this article, give this <a href=https://github.com/sekunho/webecho>GitHub repository</a> a look!</blockquote><h2 id=footnotes><a href=#footnotes>Footnotes</a></h2><div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p><a href=https://ryantm.github.io/nixpkgs/builders/images/dockertools><code>ryantm</code>’s NixOS manual</a></div><div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p><a href=https://nixos.org/manual/nixpkgs/unstable/#ssec-pkgs-dockerTools-streamLayeredImage>Official NixOS manual for <code>streamLayeredImage</code></a></div><footer><img src=/assets/images/not-by-ai.png style=width:8rem><div>Copyright <a href=https://github.com/sekunho>SEKUN</a> 2022-2025. Generated by <a href=/projects/puggle><code>puggle</code></a>.</div></footer><a href=https://mastodon.social/@sekun rel=me style=display:none>Mastodon</a><script>(function a(b){b.querySelectorAll(`template[shadowrootmode]`).forEach(b=>{const c=b.getAttribute(`shadowrootmode`);const d=b.parentNode.attachShadow({mode:c});d.appendChild(b.content);b.remove();a(d)})})(document)</script>