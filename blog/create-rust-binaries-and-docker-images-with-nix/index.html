<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Create Rust binaries, and Docker images with Nix - sekun</title>

    <link rel="stylesheet" href="/assets/css/style.css"/>

    <link rel="icon" href="/assets/images/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/favicon-16x16.png">
    <link rel="apple-touch-icon" href="/assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/favicon-32x32.png">
    <link rel="mask-icon" href="/assets/images/safari-pinned-tab.svg">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    
  <meta name="title" content="Create Rust binaries, and Docker images with Nix" />
  <meta name="description" content="While it did simplify things such as dependency management across different
environments, and the deploy process, setting up is pretty complicated. I had
to look through different references and the Nix matrix channel just to find a
description of an attribute. Things aren't as well-documented but there's a lot
of community effort to make this less painful.
" />

  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://metatags.io/" />
  <meta property="og:title" content="Create Rust binaries, and Docker images with Nix" />
  <meta property="og:description" content="While it did simplify things such as dependency management across different
environments, and the deploy process, setting up is pretty complicated. I had
to look through different references and the Nix matrix channel just to find a
description of an attribute. Things aren't as well-documented but there's a lot
of community effort to make this less painful.
" />
  <meta property="og:image" content="https://sekun.net/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/cover.png" />

  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content="https://metatags.io/" />
  <meta property="twitter:title" content="Create Rust binaries, and Docker images with Nix" />
  <meta property="twitter:description" content="While it did simplify things such as dependency management across different
environments, and the deploy process, setting up is pretty complicated. I had
to look through different references and the Nix matrix channel just to find a
description of an attribute. Things aren't as well-documented but there's a lot
of community effort to make this less painful.
" />
  <meta property="twitter:image" content="https://sekun.net/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/cover.png" />

  </head>

  <body>
    <nav class="nav">
  <ul>
    <li><a href="/">λsekun.net</a></li>
    <li><a href="/blog">/blog</a></li>
    <li><a href="/projects">/projects</a></li>
    <li><a href="/contact">/contact</a></li>
  </ul>
</nav>
    
<h1 id="create-rust-binaries,-and-docker-images-with-nix"><a href="#create-rust-binaries,-and-docker-images-with-nix">Create Rust binaries, and Docker images with Nix</a></h1><div>

</div>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/cover.png" alt="Nix logo with arrows pointing from it to the Rust logo, and the Docker logo"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<span class="post-metadata">
  Published on <time datetime="2022-04-11T06:20:00+00:00">2022-04-11 06:20 UTC</time>
</span>
<div>


  <div class="tags">
  
    <span>nix</span>
  
    <span>emojied</span>
  
    <span>docker</span>
  
    <span>rust</span>
  
    <span>github actions</span>
  
  </div>

</div>
<h2 id="introduction"><a href="#introduction">Introduction</a></h2>
<p>A few days ago, I <a href="/posts/what-i-learned-from-building-a-rust-emoji-url-shortener">released</a>
<del>the abomination of</del> a project called <code>emojied</code>
(<a href="https://emojied.net">website</a>, <a href="https://github.com/sekunho/emojied">repo</a>) to
the world. It went great, I’m glad people found it funny. However, I’m not too
pleased with the deployment process: from building the project to shipping it.
I made heavy use of Docker to build the necessary static assets, and binary.</p>
<p>Here’s the current setup:</p>
<ul>
<li>Dev environment
<ul>
<li>PostgreSQL (handled by NixOS)</li>
<li><code>rustc</code>, <code>openssl</code>, <code>cargo</code>, etc. (handled by Nix)</li>
</ul>
</li>
<li>CI/CD (GitHub Actions)
<ol>
<li>Build static assets (just in GitHub Actions)</li>
<li>Build static binary (Docker, <code>ekidd/rust-musl-builder</code>)</li>
<li>Build prod image (Docker, <code>alpine</code>)</li>
</ol>
</li>
</ul>
<p>I’ve already tried to remove as much responsibility from #3 by building the
static assets, and binary beforehand; I really need to do is copy it over.
#2 is where the pain is because it does not reuse the dependencies from #1.
So, I have two options here:</p>
<ol>
<li>Use Docker for everything, but this complicates my dev environment cause now
I have to deal with containers; or</li>
<li>I use Nix for everything, including constructing the prod image.</li>
</ol>
<p>I dislike the idea of using containers if all you want is reproducibility
because it seems like an overkill. It’s annoying to setup volumes, annoying to
manage permissions, annoying to wait for it to pull an entire image. On the other
hand, while Nix is pretty difficult, it seems like a saner approach for what I
want to do, so I chose it.</p>
<p>So, here’s how it went. (Spoiler: Kinda painful to setup)</p>
<h2 id="starting-point"><a href="#starting-point">Starting point</a></h2>
<p>This is the starting flake file:</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">description </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">inputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># 1
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">nixpkgs</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:NixOS/nixpkgs</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># Like `nixpkgs` but more bleeding-edge
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">nixos-unstable</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:NixOS/nixpkgs/nixos-unstable</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># 2
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">flake-utils</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:numtide/flake-utils</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># 3
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">naersk</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">url </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">github:nix-community/naersk</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">outputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{ self</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">nixos-unstable</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">flake-utils</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">naersk }:
</span><span style="color:#fbf1c7;">    flake-utils</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">eachSystem [ &quot;</span><span style="color:#b8bb26;">x86_64-linux</span><span style="color:#fbf1c7;">&quot; ] (system:
</span><span style="color:#fbf1c7;">      </span><span style="color:#fb4934;">let </span><span style="color:#fabd2f;">pkgs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">legacyPackages</span><span style="color:#8ec07c;">.</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">           </span><span style="color:#fabd2f;">naersk-lib </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">naersk</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">&quot;</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">override {
</span><span style="color:#fbf1c7;">             </span><span style="color:#fabd2f;">cargo </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">cargo;
</span><span style="color:#fbf1c7;">             </span><span style="color:#fabd2f;">rustc </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">rustc;
</span><span style="color:#fbf1c7;">           };
</span><span style="color:#fbf1c7;">      </span><span style="color:#fb4934;">in rec </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">        </span><span style="font-style:italic;color:#928374;"># Build binary
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">packages</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">naersk-lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildPackage {
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">pname </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">root </span><span style="color:#8ec07c;">= </span><span style="color:#b8bb26;">./.</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">        };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="font-style:italic;color:#928374;"># The package that gets built when I run `nix build`
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">defaultPackage </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">apps</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">flake-utils</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">mkApp {
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">drv </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">        };
</span><span style="color:#fbf1c7;">      });
</span><span style="color:#fbf1c7;">}
</span></pre>
<ol>
<li><a href="https://nixos.wiki/wiki/Nixpkgs"><code>nixpkgs</code></a> is like a package repository.
This is where you get <code>rustc</code>, <code>cargo</code>, etc. for example.</li>
<li><a href="https://github.com/numtide/flake-utils"><code>flake-utils</code></a> just makes dealing
with flakes a bit more convenient, especially with multiple OSes (only doing
Linux for now).</li>
<li><a href="https://github.com/nix-community/naersk"><code>naersk</code></a> makes it easier to build
static Rust binaries.</li>
</ol>
<p>These are all <em>inputs</em>, where everything in the <code>outputs</code> field is sourced
from. <code>outputs</code> is where everything gets packaged. Another thing is, to help
with reproducibility, it pins these inputs to a specific GitHub commit via a
lock file. So no version numbers, but down to the commit. This is how projects
can be built in the future in the exact same way as now.</p>
<p>If you peek into <code>flake.lock</code>, you’ll find something like this:</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">naersk</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">inputs</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">nixpkgs</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">nixpkgs</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">  },
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">locked</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">lastModified</span><span style="color:#fbf1c7;">&quot;: </span><span style="color:#d3869b;">1649096192</span><span style="color:#fbf1c7;">,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">narHash</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">sha256-7O8e+eZEYeU+ET98u/zW5epuoN/xYx9G+CIh4DjZVzY=</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">owner</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">nix-community</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">repo</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">naersk</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">rev</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">d626f73332a8f587b613b0afe7293dd0777be07d</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">type</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">github</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">  },
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">original</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">owner</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">nix-community</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">repo</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">naersk</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">type</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">github</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">  }
</span><span style="color:#fbf1c7;">},
</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">nixpkgs</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">locked</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">lastModified</span><span style="color:#fbf1c7;">&quot;: </span><span style="color:#d3869b;">1648219316</span><span style="color:#fbf1c7;">,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">narHash</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">sha256-Ctij+dOi0ZZIfX5eMhgwugfvB+WZSrvVNAyAuANOsnQ=</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">owner</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">NixOS</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">repo</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">nixpkgs</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">rev</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">30d3d79b7d3607d56546dd2a6b49e156ba0ec634</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">type</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">github</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">  },
</span><span style="color:#fbf1c7;">  &quot;</span><span style="color:#b8bb26;">original</span><span style="color:#fbf1c7;">&quot;: {
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">id</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">nixpkgs</span><span style="color:#fbf1c7;">&quot;,
</span><span style="color:#fbf1c7;">    &quot;</span><span style="color:#b8bb26;">type</span><span style="color:#fbf1c7;">&quot;: &quot;</span><span style="color:#b8bb26;">indirect</span><span style="color:#fbf1c7;">&quot;
</span><span style="color:#fbf1c7;">  }
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>There are more stuff in it, but hopefully this will make things a bit clearer.</p>
<p>That’s the best ELI5 I can think of, so I recommend you check out the
<a href="https://nixos.wiki/wiki/Flakes">documentation</a> for a more technical explanation.</p>
<p>So, I run <code>nix build</code> and…</p>
<h2 id="problem-0:-openssl"><a href="#problem-0:-openssl">Problem 0: OpenSSL</a></h2>
<p>Bam.</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">error:</span><span style="color:#fbf1c7;"> builder for &#39;</span><span style="color:#b8bb26;">/nix/store/pv9szkam1rawk40ywp3v89k53zg4b1l4-emojied-deps-0.1.0.drv</span><span style="color:#fbf1c7;">&#39; failed with exit code 101</span><span style="color:#8ec07c;">;
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">last</span><span style="color:#fbf1c7;"> 10 log lines:
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">   It </span><span style="color:#8ec07c;">looks</span><span style="color:#fbf1c7;"> like you&#39;</span><span style="color:#b8bb26;">re compiling on Linux and also targeting Linux. Currently this
</span><span style="color:#b8bb26;">       &gt;   requires the `pkg-config` utility to find OpenSSL but unfortunately `pkg-config`
</span><span style="color:#b8bb26;">       &gt;   could not be found. If you have OpenSSL installed you can likely fix this by
</span><span style="color:#b8bb26;">       &gt;   installing `pkg-config`.
</span><span style="color:#b8bb26;">       &gt;
</span><span style="color:#b8bb26;">       &gt;   </span><span style="color:#fbf1c7;">&#39;, /sources/openssl-sys-0.9.72/build/find_normal.rs:180:5
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">   note: </span><span style="color:#8ec07c;">run</span><span style="color:#fbf1c7;"> with `</span><span style="color:#83a598;">RUST_BACKTRACE</span><span style="color:#8ec07c;">=</span><span style="color:#b8bb26;">1</span><span style="color:#fbf1c7;">` environment variable to display a backtrace
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> warning: </span><span style="color:#8ec07c;">build</span><span style="color:#fbf1c7;"> failed, waiting for other jobs to finish...
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> error: </span><span style="color:#8ec07c;">build</span><span style="color:#fbf1c7;"> failed
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">&gt; </span><span style="color:#fb4934;">[</span><span style="color:#fbf1c7;">naersk</span><span style="color:#fb4934;">] </span><span style="color:#8ec07c;">cargo</span><span style="color:#fbf1c7;"> returned with exit code 101, exiting
</span><span style="color:#fbf1c7;">       </span><span style="color:#8ec07c;">For</span><span style="color:#fbf1c7;"> full logs, run &#39;</span><span style="color:#b8bb26;">nix log /nix/store/pv9szkam1rawk40ywp3v89k53zg4b1l4-emojied-deps-0.1.0.drv</span><span style="color:#fbf1c7;">&#39;.
</span><span style="color:#8ec07c;">error:</span><span style="color:#fbf1c7;"> 1 dependencies of derivation &#39;</span><span style="color:#b8bb26;">/nix/store/r0h49v7i2vg5dckb9h2g8p7na048rk4g-emojied-0.1.0.drv</span><span style="color:#fbf1c7;">&#39; failed to build
</span></pre>
<p>I’ve seen this error before! Since <code>emojied</code> uses <code>native-tls</code>, and since it’s
just a wrapper around OpenSSL, I need to have OpenSSL around. Thankfully,
<code>naersk</code> has a <code>buildInputs</code> attribute for us to use.</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied </span><span style="background-color:#fb4934;color:#fbf1c7;">=</span><span style="color:#fbf1c7;"> naersk-lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildPackage {
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">pname </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">root </span><span style="color:#8ec07c;">= </span><span style="color:#b8bb26;">./.</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">buildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fb4934;">with </span><span style="color:#fbf1c7;">pkgs; [ openssl pkg-config ];
</span><span style="color:#fbf1c7;">}</span><span style="background-color:#fb4934;color:#fbf1c7;">;</span><span style="color:#fbf1c7;">
</span></pre>
<p>Ran <code>nix build</code>, and I’m greeted with another problem!</p>
<h2 id="problem-1:-<code>git</code>-submodule-woes"><a href="#problem-1:-<code>git</code>-submodule-woes">Problem 1: <code>git</code> submodule woes</a></h2><pre style="background-color:#282828;">
<span style="color:#8ec07c;">Compiling</span><span style="color:#fbf1c7;"> maud_macros v0.23.0 (https://github.com/lambda-fairy/maud</span><span style="color:#8ec07c;">?</span><span style="color:#fbf1c7;">branch=main#e6787cd6)
</span><span style="color:#8ec07c;">error:</span><span style="color:#fbf1c7;"> could not compile `</span><span style="color:#8ec07c;">maud_macros</span><span style="color:#fbf1c7;">` due to 3 previous errors
</span><span style="color:#8ec07c;">warning:</span><span style="color:#fbf1c7;"> build failed, waiting for other jobs to finish...
</span><span style="color:#8ec07c;">error:</span><span style="color:#fbf1c7;"> build failed
</span><span style="color:#8ec07c;">error[E0583]:</span><span style="color:#fbf1c7;"> file not found for module `</span><span style="color:#8ec07c;">escape</span><span style="color:#fbf1c7;">`
</span><span style="color:#fbf1c7;"> </span><span style="color:#8ec07c;">--&gt;</span><span style="color:#fbf1c7;"> /sources/maud_macros-0.23.0-e6787cd62165a075c7f16a32f8bbacc398f52d13/src/lib.rs:9:1
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">|
</span><span style="color:#8ec07c;">9 | mod</span><span style="color:#fbf1c7;"> escape</span><span style="color:#8ec07c;">;
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">| ^^^^^^^^^^^
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">|
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">= help:</span><span style="color:#fbf1c7;"> to create the module `</span><span style="color:#8ec07c;">escape</span><span style="color:#fbf1c7;">`, create file &quot;</span><span style="color:#b8bb26;">/nix/store/shixfmbv64zzi9i0rzb9c8870ydm7cf2-crates-io/maud_macr&gt;
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">error[E0425]: cannot find function </span><span style="color:#fbf1c7;">`</span><span style="color:#8ec07c;">escape_to_string</span><span style="color:#fbf1c7;">`</span><span style="color:#b8bb26;"> in module </span><span style="color:#fbf1c7;">`</span><span style="color:#8ec07c;">escape</span><span style="color:#fbf1c7;">`
</span><span style="color:#b8bb26;">   --&gt; /sources/maud_macros-0.23.0-e6787cd62165a075c7f16a32f8bbacc398f52d13/src/generate.rs:272:17
</span><span style="color:#b8bb26;">    |
</span><span style="color:#b8bb26;">272 |         escape::escape_to_string(string, &amp;mut self.tail);
</span><span style="color:#b8bb26;">    |                 ^^^^^^^^^^^^^^^^ not found in </span><span style="color:#fbf1c7;">`</span><span style="color:#8ec07c;">escape</span><span style="color:#fbf1c7;">`
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">error: aborting due to 2 previous errors
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">Some errors have detailed explanations: E0425, E0583.
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">For more information about an error, try </span><span style="color:#fbf1c7;">`</span><span style="color:#8ec07c;">rustc</span><span style="color:#fbf1c7;"> --explain E0425`</span><span style="color:#b8bb26;">.
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">[naersk] cargo returned with exit code 101, exiting
</span></pre>
<p>It’s telling me that <code>cargo</code> can’t resolve the <code>escape</code> module for <code>maud_macros</code>.
I took a look at the <a href="https://github.com/lambda-fairy/maud/tree/main/maud_macros/src">source</a>,
and initially seemed like it’s a submodule:</p>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/maud-dir.png" alt="Screenshot of maud's GitHub repository"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<p>Turns out there’s a ticket (<a href="https://github.com/nix-community/naersk/issues/110">#110</a>)
pointing out that submodules isn’t supported by <code>naersk</code>. Fortunately, by the
time I read this, there was a PR ready that fixed this. All it required was
adding <code>gitSubmodules = true;</code>:</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied </span><span style="background-color:#fb4934;color:#fbf1c7;">=</span><span style="color:#fbf1c7;"> naersk-lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildPackage {
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">pname </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">root </span><span style="color:#8ec07c;">= </span><span style="color:#b8bb26;">./.</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">gitSubmodules </span><span style="color:#8ec07c;">= </span><span style="color:#d3869b;">true</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">}</span><span style="background-color:#fb4934;color:#fbf1c7;">;</span><span style="color:#fbf1c7;">
</span></pre>
<p>So this fixes everything then, right?</p>
<p>Wrong.</p>
<h2 id="problem-2:-symlink-woes"><a href="#problem-2:-symlink-woes">Problem 2: Symlink woes</a></h2>
<p>Remember how I said it was a submodule? Well, it turns out that <code>escape.rs</code> is
actually a symlink (the icons look too similar!). <code>cargo</code> handles it just fine
so running <code>cargo build</code> will work out. But this isn’t the case for <code>naersk</code>. I
couldn’t find any issue talking about symlinks so I opened one
(<a href="https://github.com/nix-community/naersk/issues/230">#230</a>). Unfortunately, I
had no idea how to fix it, so I just decided to manually clone it, and remove
the symlink for a copy instead. It’s only one file, so it isn’t that big of a
deal.</p>
<p>Kind of a hack, but it works now! A binary is available in <code>./result/bin/</code>,
albeit a symlink. I ran it with:</p>
<pre style="background-color:#282828;">
<span style="color:#83a598;">PG__DBNAME</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied_db</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__HOST</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">localhost</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__USER</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">sekun</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__PORT</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">5432</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">./result/bin/emojied
</span></pre>
<p>…and I was greeted with this unstyled page:</p>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/no-static-assets.png" alt="Unstyled emojied.net frontpage"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<h2 id="problem-3:-static-assets"><a href="#problem-3:-static-assets">Problem 3: Static assets</a></h2>
<p><code>emojied</code> is comprised of two things: a server binary, and static assets. These
static assets are built using <code>tailwindcss</code>’s CLI, and <code>esbuild</code>… which was
not handled by <code>naersk</code>. It does not seem to provide an escape hatch, which
makes sense anyway cause it would be kinda weird to do things unrelated to Rust
in a Rust builder.</p>
<p>Now what?</p>
<p>Well, I found out about <code>overrideAttrs</code> and it is wonderful.</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">outputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{ self</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">nixos-unstable</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">flake-utils</span><span style="color:#8ec07c;">, </span><span style="color:#fbf1c7;">naersk }:
</span><span style="color:#fbf1c7;">    flake-utils</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">eachSystem [ &quot;</span><span style="color:#b8bb26;">x86_64-linux</span><span style="color:#fbf1c7;">&quot; ] (system:
</span><span style="color:#fbf1c7;">      </span><span style="color:#fb4934;">let </span><span style="color:#fabd2f;">pkgs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">nixpkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">legacyPackages</span><span style="color:#8ec07c;">.</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">unstablepkgs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">nixos-unstable</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">legacyPackages</span><span style="color:#8ec07c;">.</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">naersk-lib </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">naersk</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">&quot;</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">system</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">override {
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">cargo </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">cargo;
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">rustc </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">rustc;
</span><span style="color:#fbf1c7;">          };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">          </span><span style="font-style:italic;color:#928374;"># I moved it up here so I could bind it to `emojied`.
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">(naersk-lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildPackage {
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">pname </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">root </span><span style="color:#8ec07c;">= </span><span style="color:#b8bb26;">./.</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">nativeBuildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fb4934;">with </span><span style="color:#fbf1c7;">pkgs; [ ];
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">buildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fb4934;">with </span><span style="color:#fbf1c7;">pkgs; [ openssl pkg-config ];
</span><span style="color:#fbf1c7;">          })</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">overrideAttrs (old: {
</span><span style="color:#fbf1c7;">            </span><span style="font-style:italic;color:#928374;"># I get access to `old` which has the previous attributes.
</span><span style="color:#fbf1c7;">            </span><span style="font-style:italic;color:#928374;"># And I get to override anything!
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">nativeBuildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">old</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nativeBuildInputs </span><span style="color:#8ec07c;">++ </span><span style="color:#fbf1c7;">[
</span><span style="color:#fbf1c7;">              unstablepkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nodePackages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">typescript
</span><span style="color:#fbf1c7;">              unstablepkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">nodePackages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">tailwindcss
</span><span style="color:#fbf1c7;">              unstablepkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">esbuild
</span><span style="color:#fbf1c7;">            ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">buildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">old</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildInputs;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">buildPhase </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">old</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildPhase </span><span style="color:#8ec07c;">+ </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">              tailwindcss \
</span><span style="color:#b8bb26;">                --input assets/app.css \
</span><span style="color:#b8bb26;">                --config assets/tailwind.config.js \
</span><span style="color:#b8bb26;">                --output public/app.css \
</span><span style="color:#b8bb26;">                --minify
</span><span style="color:#b8bb26;">
</span><span style="color:#b8bb26;">              esbuild \
</span><span style="color:#b8bb26;">                assets/app.ts \
</span><span style="color:#b8bb26;">                --outdir=public/ \
</span><span style="color:#b8bb26;">                --minify
</span><span style="color:#b8bb26;">            </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            </span><span style="color:#fabd2f;">installPhase </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">old</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">installPhase </span><span style="color:#8ec07c;">+ </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">              mv public $out/bin
</span><span style="color:#b8bb26;">              mv bin/run $out/bin/run
</span><span style="color:#b8bb26;">            </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">          });
</span><span style="color:#fbf1c7;">      </span><span style="color:#fb4934;">in
</span><span style="color:#fbf1c7;">      </span><span style="color:#fb4934;">rec </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">packages</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">defaultPackage </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">apps</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">flake-utils</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">lib</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">mkApp {
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">drv </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">        };
</span><span style="color:#fbf1c7;">      });
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>I removed <code>gitSubmodules = true</code> since it wasn’t necessary anymore. <code>buildPackage</code>
just spits out an attribute set, I can override it to add more things. Here, I
added new native build inputs (build time), new steps to <code>buildPhase</code>, and
<code>installPhase</code> for the static assets.</p>
<p>And I ran it like this:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">cd</span><span style="color:#fbf1c7;"> result/bin
</span><span style="color:#fbf1c7;">
</span><span style="color:#83a598;">PG__DBNAME</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied_db</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__HOST</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">localhost</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__USER</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">sekun</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__PORT</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">5432</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">./emojied
</span></pre>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/has-static-assets.png" alt="STyled emojied.net frontpage"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<p>Beautiful.</p>
<p>Okay, so that seems to work but I have to run <code>emojied</code> in the same directory as
<code>public/</code> cause otherwise it won’t find anything. Which is expected because:</p>
<pre style="background-color:#282828;">
<span style="color:#fb4934;">pub</span><span style="color:#fbf1c7;"> async </span><span style="color:#8ec07c;">fn </span><span style="color:#b8bb26;">stylesheet</span><span style="color:#fbf1c7;">() -&gt; (StatusCode, HeaderMap, String) {
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">let mut</span><span style="color:#fbf1c7;"> headers </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">HeaderMap::new();
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">match </span><span style="color:#fbf1c7;">fs::read_to_string(&quot;</span><span style="color:#b8bb26;">public/app.css</span><span style="color:#fbf1c7;">&quot;) {
</span><span style="color:#fbf1c7;">                           </span><span style="font-style:italic;color:#928374;">// ^ Relative path. Good job me!
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">Ok</span><span style="color:#fbf1c7;">(content) </span><span style="color:#8ec07c;">=&gt; </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">            headers.</span><span style="color:#8ec07c;">insert</span><span style="color:#fbf1c7;">(
</span><span style="color:#fbf1c7;">                HeaderName::from_static(&quot;</span><span style="color:#b8bb26;">content-type</span><span style="color:#fbf1c7;">&quot;),
</span><span style="color:#fbf1c7;">                HeaderValue::from_static(&quot;</span><span style="color:#b8bb26;">text/css; charset=utf-8</span><span style="color:#fbf1c7;">&quot;),
</span><span style="color:#fbf1c7;">            );
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            (StatusCode::</span><span style="color:#d3869b;">OK</span><span style="color:#fbf1c7;">, headers, content)
</span><span style="color:#fbf1c7;">        }
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">Err</span><span style="color:#fbf1c7;">(_e) </span><span style="color:#8ec07c;">=&gt; </span><span style="color:#fbf1c7;">(StatusCode::</span><span style="color:#d3869b;">NOT_FOUND</span><span style="color:#fbf1c7;">, headers, </span><span style="color:#fabd2f;">String</span><span style="color:#fbf1c7;">::from(&quot;</span><span style="color:#b8bb26;">Not found</span><span style="color:#fbf1c7;">&quot;)),
</span><span style="color:#fbf1c7;">    }
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>I’m using relative paths! But other than that, it works. It’s not exactly an issue
for the way I’m using it, which is:</p>
<ol>
<li>Build the binary</li>
<li>Build static assets</li>
<li>Copy files from #1 and #2, and throw it into an image.</li>
</ol>
<p>But with <code>nix run</code>, it gives me broken styles again. I don’t want it to depend
on where I run it! So. Close.</p>
<h2 id="problem-4:-making-it-work™"><a href="#problem-4:-making-it-work™">Problem 4: Making it work™</a></h2>
<p>So the problem is that the file paths are relative which makes it depend on
where I run the binary. The plan then is to provide the static asset directory
path during runtime!</p>
<p>This way it’s flexible enough to:</p>
<ol>
<li>Ship off to a Docker image; and</li>
<li>Use <code>nix run</code> without breaking anything.</li>
</ol>
<p>Something like this would be nice:</p>
<pre style="background-color:#282828;">
<span style="color:#d3869b;">PG__DBNAME</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied_db</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#d3869b;">PG__HOST</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">localhost</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#d3869b;">PG__USER</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">sekun</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#d3869b;">PG__PORT</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">5432</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#d3869b;">APP__STATIC_ASSETS</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">/foo/bar/public/</span><span style="color:#fbf1c7;">&quot; \
</span><span style="color:#fbf1c7;">  .</span><span style="color:#8ec07c;">/</span><span style="color:#fbf1c7;">emojied
</span></pre>
<p>I added another field to <code>AppConfig</code>, and checked if there’s an argument called
<code>static_assets_path</code>:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;">// src/config.rs
</span><span style="color:#fbf1c7;">
</span><span style="color:#fb4934;">struct </span><span style="color:#fbf1c7;">AppConfig {
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">pub </span><span style="color:#83a598;">static_assets_path</span><span style="color:#fbf1c7;">: String </span><span style="font-style:italic;color:#928374;">// See disclaimer below
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>Loaded it from the environment:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;">// src/config.rs
</span><span style="color:#fbf1c7;">
</span><span style="color:#fb4934;">let</span><span style="color:#fbf1c7;"> static_assets_path </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">env::var(&quot;</span><span style="color:#b8bb26;">APP__STATIC_ASSETS</span><span style="color:#fbf1c7;">&quot;)
</span><span style="color:#fbf1c7;">    .</span><span style="color:#8ec07c;">map_err</span><span style="color:#fbf1c7;">(|_| Error::MissingStaticAssetsPath)</span><span style="color:#8ec07c;">?</span><span style="color:#fbf1c7;">;
</span><span style="color:#fbf1c7;">
</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fbf1c7;">
</span><span style="color:#fabd2f;">Ok</span><span style="color:#fbf1c7;">(AppConfig {
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fbf1c7;">    static_assets_path, </span><span style="font-style:italic;color:#928374;">// New!
</span><span style="color:#fbf1c7;">})
</span></pre>
<p>Add <code>AppConfig</code> to the middleware:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fb4934;">let</span><span style="color:#fbf1c7;"> config </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">Arc::new(config);
</span><span style="color:#fbf1c7;">
</span><span style="color:#fb4934;">let</span><span style="color:#fbf1c7;"> app </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">Router::new()
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fbf1c7;">    .</span><span style="color:#8ec07c;">layer</span><span style="color:#fbf1c7;">(Extension(config));
</span></pre>
<p>And in the functions serving the files:</p>
<pre style="background-color:#282828;">
<span style="color:#fb4934;">pub</span><span style="color:#fbf1c7;"> async </span><span style="color:#8ec07c;">fn </span><span style="color:#b8bb26;">js</span><span style="color:#fbf1c7;">(
</span><span style="color:#fbf1c7;">    Extension(config): Extension&lt;Arc&lt;AppConfig&gt;&gt; </span><span style="font-style:italic;color:#928374;">// New
</span><span style="color:#fbf1c7;">) -&gt; (StatusCode, HeaderMap, String) {
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">let mut</span><span style="color:#fbf1c7;"> headers </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">HeaderMap::new();
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">let mut</span><span style="color:#fbf1c7;"> static_assets_path </span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;"> config.static_assets_path.</span><span style="color:#8ec07c;">clone</span><span style="color:#fbf1c7;">(); </span><span style="font-style:italic;color:#928374;">// New
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    static_assets_path.</span><span style="color:#8ec07c;">push_str</span><span style="color:#fbf1c7;">(&quot;</span><span style="color:#b8bb26;">public/app.js</span><span style="color:#fbf1c7;">&quot;); </span><span style="font-style:italic;color:#928374;">// New
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">                          </span><span style="font-style:italic;color:#928374;">// Shiny, new path
</span><span style="color:#fbf1c7;">    </span><span style="color:#fb4934;">match </span><span style="color:#fbf1c7;">fs::read_to_string(static_assets_path) {
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">Ok</span><span style="color:#fbf1c7;">(content) </span><span style="color:#8ec07c;">=&gt; </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">            headers.</span><span style="color:#8ec07c;">insert</span><span style="color:#fbf1c7;">(
</span><span style="color:#fbf1c7;">                HeaderName::from_static(&quot;</span><span style="color:#b8bb26;">content-type</span><span style="color:#fbf1c7;">&quot;),
</span><span style="color:#fbf1c7;">                HeaderValue::from_static(&quot;</span><span style="color:#b8bb26;">application/javascript; charset=utf-8</span><span style="color:#fbf1c7;">&quot;),
</span><span style="color:#fbf1c7;">            );
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">            (StatusCode::</span><span style="color:#d3869b;">OK</span><span style="color:#fbf1c7;">, headers, content)
</span><span style="color:#fbf1c7;">        }
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">Err</span><span style="color:#fbf1c7;">(_e) </span><span style="color:#8ec07c;">=&gt; </span><span style="color:#fbf1c7;">(StatusCode::</span><span style="color:#d3869b;">NOT_FOUND</span><span style="color:#fbf1c7;">, headers, </span><span style="color:#fabd2f;">String</span><span style="color:#fbf1c7;">::from(&quot;</span><span style="color:#b8bb26;">Not found</span><span style="color:#fbf1c7;">&quot;)),
</span><span style="color:#fbf1c7;">    }
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>…which I then repeated in 2 more functions because I was too lazy to make one
endpoint for static assets. Now, I feel the pain of my laziness.</p>
<blockquote>
<p>Disclaimer: Before you come after me with pitchforks, I later did a tiny
refactor which uses <code>PathBuf</code> rather than a <code>String</code>.</p>
</blockquote>
<p>Okay, but then I still need a way to set the environment variable automatically,
right? Currently, it’s not very convenient to do it every time it’s called with
<code>nix run</code>. Turns out <a href="https://nixos.wiki/wiki/Nix_Cookbook"><code>makeWrapper</code></a> exists.
(Thanks K900!)</p>
<pre style="background-color:#282828;">
<span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">packages</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied-unwrapped </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">emojied;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">        </span><span style="font-style:italic;color:#928374;"># New
</span><span style="color:#fbf1c7;">        </span><span style="color:#fabd2f;">packages</span><span style="color:#fbf1c7;">.</span><span style="color:#fabd2f;">emojied </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">symlinkJoin {
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">name </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">paths </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ emojied ];
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">buildInputs </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">makeWrapper ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">          </span><span style="color:#fabd2f;">postBuild </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&#39;&#39;
</span><span style="color:#b8bb26;">            wrapProgram $out/bin/emojied \
</span><span style="color:#b8bb26;">              --set APP__STATIC_ASSETS &quot;</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">emojied</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#b8bb26;">/bin/public&quot;
</span><span style="color:#b8bb26;">                                      # ^ What a convenient way to get the path
</span><span style="color:#b8bb26;">          </span><span style="color:#fbf1c7;">&#39;&#39;;
</span><span style="color:#fbf1c7;">        };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#fbf1c7;">}
</span></pre>
<p>So I’ll get the “wrapped” version of emojied with <code>nix build</code>, which has the
static assets path already applied. Doing so gets me this:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (chore/nixify-package)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> nix </span><span style="color:#8ec07c;">build
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (chore/nixify-package)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> ls </span><span style="color:#8ec07c;">-la</span><span style="color:#fbf1c7;"> result/bin
</span><span style="color:#8ec07c;">total</span><span style="color:#fbf1c7;"> 20
</span><span style="color:#8ec07c;">dr-xr-xr-x</span><span style="color:#fbf1c7;"> 3 root root 4096 Jan  1  1970 .
</span><span style="color:#8ec07c;">dr-xr-xr-x</span><span style="color:#fbf1c7;"> 3 root root 4096 Jan  1  1970 ..
</span><span style="color:#8ec07c;">-r-xr-xr-x</span><span style="color:#fbf1c7;"> 1 root root  264 Jan  1  1970 emojied
</span><span style="color:#8ec07c;">lrwxrwxrwx</span><span style="color:#fbf1c7;"> 1 root root   69 Jan  1  1970 .emojied-wrapped -</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> /nix/store/7nh13gwhhlmfmmb6qss47axj7nd99jw7-emojied-0.1.0/bin/emojied
</span><span style="color:#8ec07c;">dr-xr-xr-x</span><span style="color:#fbf1c7;"> 2 root root 4096 Jan  1  1970 public
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (chore/nixify-package)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> ls </span><span style="color:#8ec07c;">-la
</span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#8ec07c;">lrwxrwxrwx</span><span style="color:#fbf1c7;">  1 sekun users      51 Apr 12 22:55 result -</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> /nix/store/300n6rjxm88asmqhv99hid9mi8148xjs-emojied
</span><span style="font-style:italic;color:#928374;">#...
</span></pre>
<p>So, it symlinked <code>.emojied-wrapped</code> to the original <code>emojied</code>, and <code>result</code> is
symlinked to a wrapped version of it. Is this another derivation? Seems like it,
although I don’t really know since I’m not so familiar with this. I’ll have to
do more reading. I’m just gonna manually test it to verify if it all works.
<code>.#emojied-unwrapped</code> needs to complain about the missing assets path if I don’t
provide one, and <code>.#emojied</code> shouldn’t.</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (chore/nixify-package)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> PG__DBNAME=&quot;</span><span style="color:#b8bb26;">emojied_db</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__HOST</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">localhost</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__USER</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">sekun</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#83a598;">PG__PORT</span><span style="color:#8ec07c;">=</span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">5432</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#8ec07c;">nix</span><span style="color:#fbf1c7;"> run .#emojied-unwrapped
</span><span style="color:#8ec07c;">Loading</span><span style="color:#fbf1c7;"> configuration from environment
</span><span style="color:#8ec07c;">Application</span><span style="color:#fbf1c7;"> config error: Missing environment variable: `</span><span style="color:#83a598;">APP__STATIC_ASSETS</span><span style="color:#8ec07c;">=&lt;</span><span style="color:#fbf1c7;">PATH_TO_FILES</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;">`
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (chore/nixify-package) </span><span style="color:#8ec07c;">[1]&gt;</span><span style="color:#fbf1c7;"> PG__DBNAME=&quot;</span><span style="color:#b8bb26;">emojied_db</span><span style="color:#fbf1c7;">&quot; PG__HOST=&quot;</span><span style="color:#b8bb26;">localhost</span><span style="color:#fbf1c7;">&quot; PG__USER=&quot;</span><span style="color:#b8bb26;">sekun</span><span style="color:#fbf1c7;">&quot; PG__PORT=&quot;</span><span style="color:#b8bb26;">5432</span><span style="color:#fbf1c7;">&quot; nix run
</span><span style="color:#8ec07c;">Loading</span><span style="color:#fbf1c7;"> configuration from environment
</span><span style="color:#8ec07c;">Attempting</span><span style="color:#fbf1c7;"> to establish a database connection
</span><span style="color:#8ec07c;">Database</span><span style="color:#fbf1c7;"> connection established
</span></pre>
<p>…and it works as expected. The second one also serves the static assets
just fine! Hooray.</p>
<h2 id="problem-5:-copy-all-that-to-a-docker-image"><a href="#problem-5:-copy-all-that-to-a-docker-image">Problem 5: Copy all that to a Docker image</a></h2>
<p>The final step is copying what was built by Nix to a Docker image. I’m currently
using a <code>Dockerfile</code> for that but this won’t work with this new setup. The problem
now is that Docker doesn’t resolve symlinks that point outside the context, which
is problematic since <code>result</code> is a symlink that points to some place in <code>/nix/store</code>!
I could do some dirty hacks, but I could also just use Nix to build a Docker
image for me.</p>
<p><em>Wait, did you say Nix could build Docker images?</em></p>
<p>Oh yeah, big time; <a href="https://nix.dev/tutorials/building-and-running-docker-images"><code>nix.dev</code></a>
has a great starting point [^9] for doing so.</p>
<p>Here’s what I ended up with:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;"># flake.nix
</span><span style="color:#fbf1c7;">
</span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#fbf1c7;">
</span><span style="font-style:italic;color:#928374;"># In `outputs`
</span><span style="color:#fbf1c7;">packages</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">emojied-docker </span><span style="background-color:#fb4934;color:#fbf1c7;">=</span><span style="color:#fbf1c7;"> pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">dockerTools</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">buildImage {
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">name </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">emojied-docker</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">tag </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">latest</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">contents </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ pkgs</span><span style="color:#8ec07c;">.</span><span style="color:#fbf1c7;">bash ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">  </span><span style="color:#fabd2f;">config </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">WorkingDir </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">&quot;</span><span style="color:#b8bb26;">/app</span><span style="color:#fbf1c7;">&quot;;
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">Env </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ &quot;</span><span style="color:#b8bb26;">PATH=</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">pkgs</span><span style="font-style:italic;color:#8ec07c;">.</span><span style="font-style:italic;color:#fbf1c7;">coreutils</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#b8bb26;">/bin/:</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">packages</span><span style="font-style:italic;color:#8ec07c;">.</span><span style="font-style:italic;color:#fbf1c7;">emojied</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#b8bb26;">/bin</span><span style="color:#fbf1c7;">&quot; ];
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">ExposedPorts </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{
</span><span style="color:#fbf1c7;">      &quot;</span><span style="color:#b8bb26;">3000/tcp</span><span style="color:#fbf1c7;">&quot; </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">{};
</span><span style="color:#fbf1c7;">    };
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># bin/run is a script that handles the dumping of CA certs, and runs the
</span><span style="color:#fbf1c7;">    </span><span style="font-style:italic;color:#928374;"># emojied server.
</span><span style="color:#fbf1c7;">    </span><span style="color:#fabd2f;">Cmd </span><span style="color:#8ec07c;">= </span><span style="color:#fbf1c7;">[ &quot;</span><span style="font-style:italic;color:#8ec07c;">${</span><span style="font-style:italic;color:#fbf1c7;">packages</span><span style="font-style:italic;color:#8ec07c;">.</span><span style="font-style:italic;color:#fbf1c7;">emojied</span><span style="font-style:italic;color:#8ec07c;">}</span><span style="color:#b8bb26;">/bin/run</span><span style="color:#fbf1c7;">&quot; ];
</span><span style="color:#fbf1c7;">  };
</span><span style="color:#fbf1c7;">}</span><span style="background-color:#fb4934;color:#fbf1c7;">;</span><span style="color:#fbf1c7;">
</span></pre>
<p>If you squint hard enough, the contents of <code>config</code> just looks like a Nix version
of a <code>Dockerfile</code>, which it is! The other cool part is now the package versions
are in sync no matter what environment it is in. <code>contents</code> allows me to throw
in Nix packages to the image. Since it seemed like the <code>PATH</code>s aren’t set automatically,
I had to specify it in <code>Env</code> for <code>coreutils</code>, and <code>emojied</code>.</p>
<p>It’s basically like the other packages created, like <code>emojied</code>, and
<code>emojied-unwrapped</code>. Which means I can build it in the exact same way as them:</p>
<pre style="background-color:#282828;">
<span style="font-style:italic;color:#928374;"># Don&#39;t mind the branch change. I ran this in the morning.
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (main)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> nix </span><span style="color:#8ec07c;">build</span><span style="color:#fbf1c7;"> .#emojied-docker
</span><span style="font-style:italic;color:#928374;"># some build-related output
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (main)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> ls </span><span style="color:#8ec07c;">-la
</span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#8ec07c;">lrwxrwxrwx</span><span style="color:#fbf1c7;">  1 sekun users      78 Apr 13 12:28 result -</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> /nix/store/vmrja5imhrfhvl082j5qkqahcfj85adk-docker-image-emojied-docker.tar.gz
</span><span style="font-style:italic;color:#928374;"># ...
</span></pre>
<p>Instead, <code>result</code> is a symlink to some image tar file which you can load with
<code>docker load &lt; result</code>.</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (main)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> docker </span><span style="color:#8ec07c;">load &lt;</span><span style="color:#fbf1c7;"> result
</span><span style="color:#8ec07c;">Loaded</span><span style="color:#fbf1c7;"> image: emojied-docker:latest
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">sekun@nixos </span><span style="color:#d3869b;">~</span><span style="color:#fbf1c7;">/P/emojiurl (main)</span><span style="color:#8ec07c;">&gt;</span><span style="color:#fbf1c7;"> docker </span><span style="color:#8ec07c;">images
</span><span style="font-style:italic;color:#928374;"># ...
</span><span style="color:#8ec07c;">emojied-docker</span><span style="color:#fbf1c7;"> latest 1a9092013b19 52 years ago 50MB
</span></pre>
<p>Sweet!</p>
<p>All that’s left is to update the CI for these new steps, which is on the simpler
side of things now:</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">name:</span><span style="color:#fbf1c7;"> CI/CD
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">on:
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">push:
</span><span style="color:#fbf1c7;">    </span><span style="color:#8ec07c;">branches:
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> main
</span><span style="color:#fbf1c7;">
</span><span style="color:#8ec07c;">jobs:
</span><span style="color:#fbf1c7;">  </span><span style="color:#8ec07c;">deploy:
</span><span style="color:#fbf1c7;">    </span><span style="color:#8ec07c;">name:</span><span style="color:#fbf1c7;"> Build release and deploy
</span><span style="color:#fbf1c7;">    </span><span style="color:#8ec07c;">runs-on:</span><span style="color:#fbf1c7;"> ubuntu-20.04
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">    </span><span style="color:#8ec07c;">steps:
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Checkout repo
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">uses:</span><span style="color:#fbf1c7;"> actions/checkout@v2
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Setup Nix
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">uses:</span><span style="color:#fbf1c7;"> cachix/install-nix-action@v15
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Login to Docker Hub
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">uses:</span><span style="color:#fbf1c7;"> docker/login-action@v1
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">with:
</span><span style="color:#fbf1c7;">          </span><span style="color:#8ec07c;">username: </span><span style="color:#fbf1c7;">{</span><span style="color:#458588;">%</span><span style="color:#fbf1c7;"> raw </span><span style="color:#458588;">%</span><span style="color:#fbf1c7;">}</span><span style="color:#458588;">$</span><span style="color:#fbf1c7;">{</span><span style="color:#83a598;">{ secrets.DOCKER_HUB_USERNAME </span><span style="color:#fbf1c7;">}}</span><span style="color:#8ec07c;">{</span><span style="color:#458588;">%</span><span style="color:#fbf1c7;"> endraw </span><span style="color:#458588;">%</span><span style="color:#fbf1c7;">}
</span><span style="color:#fbf1c7;">          </span><span style="color:#8ec07c;">password: </span><span style="color:#fbf1c7;">{</span><span style="color:#458588;">%</span><span style="color:#fbf1c7;"> raw </span><span style="color:#458588;">%</span><span style="color:#fbf1c7;">}</span><span style="color:#458588;">$</span><span style="color:#fbf1c7;">{</span><span style="color:#83a598;">{ secrets.DOCKER_HUB_PASSWORD </span><span style="color:#fbf1c7;">}}</span><span style="color:#8ec07c;">{</span><span style="color:#458588;">%</span><span style="color:#fbf1c7;"> endraw </span><span style="color:#458588;">%</span><span style="color:#fbf1c7;">}
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Build image
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">run: |
</span><span style="color:#fbf1c7;">          </span><span style="color:#8ec07c;">nix</span><span style="color:#fbf1c7;"> build .#emojied-docker
</span><span style="color:#fbf1c7;">          </span><span style="color:#8ec07c;">docker</span><span style="color:#fbf1c7;"> load </span><span style="color:#8ec07c;">&lt;</span><span style="color:#fbf1c7;"> result
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Rename image
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">run:</span><span style="color:#fbf1c7;"> docker tag emojied-docker:latest hsekun/emojied:latest
</span><span style="color:#fbf1c7;">
</span><span style="color:#fbf1c7;">      </span><span style="color:#8ec07c;">-</span><span style="color:#fbf1c7;"> name: Push image
</span><span style="color:#fbf1c7;">        </span><span style="color:#8ec07c;">run:</span><span style="color:#fbf1c7;"> docker push hsekun/emojied:latest
</span></pre>
<p>It’s just so much easier, and I have more confidence that the CI will work
as intended now that Nix is handling the important parts, which I can do
locally. Not to say that Docker can’t do the same thing, but I found that there
were some differences with volumes that made it painful to debug.</p>
<div>

  <x-img>
    <template shadowrootmode="open">
      <img src="/assets/images/posts/create-rust-binaries-and-docker-images-with-nix/sweet-green-gh-actions.png" alt="A screenshot of a GitHub actions job"/>

      <style>
        x-img-foo:not(:defined) > template[shadowrootmode] ~ * {
          display: none;
        }

        img {
          

          
          width: 100%;
          

          display: block;
          margin: 1rem auto;
        }
      </style>
    </template>
  </x-img>

</div>
<h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2>
<p>While it did simplify things such as dependency management across different
environments, and the deploy process, setting up is pretty complicated. I had
to look through different references and the Nix matrix channel just to find a
description of an attribute. Things aren’t as well-documented but there’s a lot
of community effort to make this less painful.</p>
<p>Edit (April 24, 2022): Turns out that it actually isn’t a static binary, and
I’ve modified the post accordingly. The upside is building the Docker image via
Nix with <code>emojied</code> in it means it’s somewhat irrelevant to require it to be a
static binary to begin with. But it does mean I can’t easily distribute it outside
<code>nix</code>, which is a bummer. Maybe I’ll hunt for a workaround in the future. Right
now, I’m not too keen into sinking a lot of time into something I won’t benefit
from.</p>


    <footer>
  <img style="width: 8rem;" src="/assets/images/not-by-ai.png">
  <div>
    Copyright <a href="https://github.com/sekunho">SEKUN</a> 2022-2025.
    Generated by <a href="/projects/puggle"><code>puggle</code></a>.
  </div>
</footer>

    <a rel="me" href="https://mastodon.social/@sekun" style="display: none;">Mastodon</a>
    <script>
      (function attachShadowRoots(root) {
        root.querySelectorAll("template[shadowrootmode]").forEach(template => {
          const mode = template.getAttribute("shadowrootmode");
          const shadowRoot = template.parentNode.attachShadow({ mode });

          shadowRoot.appendChild(template.content);
          template.remove();
          attachShadowRoots(shadowRoot);
        });
      })(document);
    </script>
  </body>
</html>