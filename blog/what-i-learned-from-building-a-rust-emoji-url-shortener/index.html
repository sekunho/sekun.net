<!doctype html><html lang=en><title>What I learned from building an emoji URL shortener in Rust - sekun</title><link href=/assets/css/style.css rel=stylesheet><link href=/assets/images/favicon.ico rel=icon><link href=/assets/images/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/assets/images/apple-touch-icon.png rel=apple-touch-icon><link href=/assets/images/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/assets/images/safari-pinned-tab.svg rel=mask-icon><meta content="width=device-width,initial-scale=1.0" name=viewport><meta charset=UTF-8><meta content="What I learned from building an emoji URL shortener in Rust" name=title><meta content="Alright, that was a lot. I did learn a lot from this experience. I actually only
read until chapter 10 of the Rust Book, and skipped to some parts like advanced
traits, and other things. I really like the fact that there's a detailed book
that talks about some idiomatic Rust patterns, and even the more advanced stuff,
that's completely FREE. How crazy is that? My wallet is spared!
" name=description><meta content=website property=og:type><meta content=https://metatags.io/ property=og:url><meta content="What I learned from building an emoji URL shortener in Rust" property=og:title><meta content="Alright, that was a lot. I did learn a lot from this experience. I actually only
read until chapter 10 of the Rust Book, and skipped to some parts like advanced
traits, and other things. I really like the fact that there's a detailed book
that talks about some idiomatic Rust patterns, and even the more advanced stuff,
that's completely FREE. How crazy is that? My wallet is spared!
" property=og:description><meta content=https://sekun.net/assets/images/posts/what-i-learned-from-building-a-rust-emoji-url-shortener/cover.png property=og:image><meta content=summary_large_image property=twitter:card><meta content=https://metatags.io/ property=twitter:url><meta content="What I learned from building an emoji URL shortener in Rust" property=twitter:title><meta content="Alright, that was a lot. I did learn a lot from this experience. I actually only
read until chapter 10 of the Rust Book, and skipped to some parts like advanced
traits, and other things. I really like the fact that there's a detailed book
that talks about some idiomatic Rust patterns, and even the more advanced stuff,
that's completely FREE. How crazy is that? My wallet is spared!
" property=twitter:description><meta content=https://sekun.net/assets/images/posts/what-i-learned-from-building-a-rust-emoji-url-shortener/cover.png property=twitter:image><body><nav class=nav><ul><li><a href=/>Œªsekun.net</a><li><a href=/blog>/blog</a><li><a href=/projects>/projects</a><li><a href=/contact>/contact</a></ul></nav><h1 id=what-i-learned-from-building-an-emoji-url-shortener-in-rust><a href=#what-i-learned-from-building-an-emoji-url-shortener-in-rust>What I learned from building an emoji URL shortener in Rust</a></h1><div></div><div><x-img> <template shadowrootmode=open><img alt="HackerNews URL pointing to a shortened emojied.net URL" src=/assets/images/posts/what-i-learned-from-building-a-rust-emoji-url-shortener/cover.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:100%;margin:1rem auto;display:block}</style></template> </x-img></div><span class=post-metadata> Published on <time datetime=2022-04-11T06:20:00+00:00>2022-04-11 06:20 UTC</time> </span><div><div class=tags><span>nix</span><span>postgresql</span><span>rust</span><span>axum</span></div></div><p>So, I made an emoji URL shortener with Rust and shared it in some places including the <a href=https://old.reddit.com/r/rust/comments/tznryk/i_made_my_first_project_with_rust_its_a_url/>Rust community</a>. And oh man this is the first thing I made that got this many visitors which is pretty nice knowing that people were curious enough to try it <del>despite them probably feeling disgusted from me bringing such a thing to existence</del>.<ul><li>Repo: <a href=https://github.com/sekunho/emojied>https://github.com/sekunho/emojied</a><li>Website: <a href=https://emojied.net>https://emojied.net</a></ul><p>Some glowing ‚ú® reviews:<blockquote><p>‚ÄúThanks, I hate it.‚Äù ‚Äì Pay08, 2022</blockquote><blockquote><p>‚Äúdownvoted for being a menace to society.‚Äù ‚Äì MultiplyAccumulate, 2022</blockquote><blockquote><p>‚Äúblursed ‚Äú ‚Äì Jaxius3</blockquote><blockquote><p>‚Äú‚ÄúMade with regret.‚Äù Hahahaha. Excellent.‚Äù ‚Äì IronWhiskers, 2022</blockquote><blockquote><p>‚ÄúWhat is wrong with you?‚Äù ‚Äì Jeff</blockquote><div><x-img> <template shadowrootmode=open><img alt="Cloudflare stats page for emojied.net" src=/assets/images/posts/what-i-learned-from-building-a-rust-emoji-url-shortener/stats.png> <style>x-img-foo:not(:defined)>template[shadowrootmode]~*{display:none}img{width:50%;margin:1rem auto;display:block}</style></template> </x-img></div><p>Here are some of the things I learned from building a simple project.<h2 id=tech-stack><a href=#tech-stack>Tech Stack</a></h2><p>After looking around, I decided to go with the following:<ul><li><code>axum</code> (web server)<li><code>maud</code> (HTML templates via Rust macros)<li><code>postgres</code> (persistent data storage and business logic)<li><code>sqitch</code> (database schema migration tool)<li><code>typescript</code> (you know what this is)<li><code>docker</code> (‚Äúsimple‚Äù deploys)<li><code>nix</code> (reproducible environments)</ul><h2 id=postgresql-procedures><a href=#postgresql-procedures>PostgreSQL Procedures</a></h2><p>Procedures are <em>extremely</em> cool although this isn‚Äôt exactly new to me. I‚Äôve been experimenting with this in one of my previous, unfinished projects called GNAWEX <sup class=footnote-reference><a href=#1>1</a></sup> (One day I will finish it don‚Äôt you worry).<p>This allows you to implement some business logic in SQL, without having to implement it in the application level. If ever PostgreSQL is a constant in your project, and intend to rewrite the app from scratch, you might just end up having to rewrite the glue rather than your business logic. <code>emojied</code> isn‚Äôt doing anything too exciting though, so I can‚Äôt really demonstrate all that is cool about it.<p>Okay, an example would be fetching a URL given an identifier, and incrementing the <code>clicks</code> column by one. Here‚Äôs an example of a procedure that does exactly that:<pre style=background-color:#282828>
<span style=color:#fb4934>CREATE FUNCTION </span><span style=color:#fbf1c7>app.</span><span style=color:#b8bb26>get_url</span><span style=color:#fbf1c7>(query </span><span style=color:#fb4934>TEXT</span><span style=color:#fbf1c7>)
</span><span style=color:#fbf1c7>                          </span><span style=color:#928374;font-style:italic>-- ^ This contains the emoji sequence `identifier`
</span><span style=color:#fbf1c7>  RETURNS </span><span style=color:#fb4934>TEXT
</span><span style=color:#fbf1c7>  LANGUAGE sql
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>AS</span><span style=color:#fbf1c7> $$
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>-- Considered as a "clicked" link whenever this gets triggered
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>UPDATE </span><span style=color:#d3869b>app</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>links
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>SET</span><span style=color:#fbf1c7> clicks </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> clicks </span><span style=color:#8ec07c>+ </span><span style=color:#d3869b>1
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>WHERE </span><span style=color:#d3869b>links</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>identifier </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> $</span><span style=color:#d3869b>1</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>-- Builds the URL so that I don't have to do this in the web server
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>SELECT</span><span style=color:#fbf1c7> concat(scheme, '</span><span style=color:#b8bb26>://</span><span style=color:#fbf1c7>', </span><span style=color:#d3869b>hosts</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>name</span><span style=color:#fbf1c7>, </span><span style=color:#fb4934>path</span><span style=color:#fbf1c7>) </span><span style=color:#8ec07c>AS</span><span style=color:#fbf1c7> url
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>FROM </span><span style=color:#d3869b>app</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>links
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>JOIN </span><span style=color:#d3869b>app</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>hosts
</span><span style=color:#fbf1c7>      ON </span><span style=color:#d3869b>links</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>host </span><span style=color:#8ec07c>= </span><span style=color:#d3869b>hosts</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>host_id
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>WHERE </span><span style=color:#d3869b>links</span><span style=color:#fbf1c7>.</span><span style=color:#d3869b>identifier </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> $</span><span style=color:#d3869b>1</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>  $$;
</span></pre><p>It‚Äôs a simple function that uses SQL as the language that expects any <code>TEXT</code>, and returns a <code>TEXT</code> as well, which is a sequence of emojis, and the URL it maps to respectively. Since whatever happens in this procedure is in the same transaction as what called it, e.g (<code>SELECT * FROM app.get_url('üçäüåê')</code>), if any of this fails, then it rolls back everything, including the incrementing of <code>clicks</code>. If this was at the application level, I‚Äôd have to reach for whatever transaction implementation it uses (like <code>Ecto.Multi</code>) which doesn‚Äôt make sense in this case cause Postgres already natively supports transactions.<p>I try to make heavy use of stored procedures as long as it‚Äôs applicable. Inserting to multiple tables with one function, fetching leaderboard entries, etc.<h2 id="error-handling-with-implicit-<code>from<t></code>"><a href="#error-handling-with-implicit-<code>from<t></code>">Error handling with implicit <code>From<t> <p>Error handling is pretty nice with Rust, especially since I was never a fan of exceptions since it made control flow so weird. Although that may be because I never really invested that much time working with them. In Rust, I like that you can do two things for errors: errors encoded as ADTs, or panic (unrecoverable). Although I‚Äôm not entirely sure if all errors can be encoded in sum types, and what can be done if ever one needs to recover from a panic. But for <code>emojied</code>, I definitely don‚Äôt have to think about that.</p> <p>What I did have to deal with was finding a more convenient way when dealing with other <code>Error</code> types. For instance, there‚Äôs <code>tokio_postgres::Error</code>, then there‚Äôs <code>env::VarError</code>, and if I need to bubble up these errors to the binary, I‚Äôm gonna need a convenient enough way to do that otherwise I‚Äôm gonna have a difficult time.</p> <p>Let‚Äôs say I have two errors, a database one, and an application one.</p> <pre style=background-color:#282828>
<span style=color:#fb4934>enum </span><span style=color:#fbf1c7>AppError {
</span><span style=color:#fbf1c7>  Foo,
</span><span style=color:#fbf1c7>  Baz
</span><span style=color:#fbf1c7>}
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>enum </span><span style=color:#fbf1c7>DbError {
</span><span style=color:#fbf1c7>    FailedToConnect,
</span><span style=color:#fbf1c7>    InvalidTLSCert
</span><span style=color:#fbf1c7>}
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>some_db_action</span><span style=color:#fbf1c7>() -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>, DbError> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>Err</span><span style=color:#fbf1c7>(DbError::FailedToConnect)
</span><span style=color:#fbf1c7>}
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>some_app_action</span><span style=color:#fbf1c7>() -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>, AppError> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> result1 </span><span style=color:#8ec07c>= some_db_action</span><span style=color:#fbf1c7>()</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> result2 </span><span style=color:#8ec07c>= some_db_action</span><span style=color:#fbf1c7>()</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(result1)
</span><span style=color:#fbf1c7>}
</span></pre> <p>This fails to compile, here‚Äôs what <code>rustc</code> says:</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>error[</span><span style=color:#d3869b>E0277</span><span style=color:#fbf1c7>]: `</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>` couldn</span><span style=color:#fb4934>'t</span><span style=color:#fbf1c7> convert the error to `AppError`
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|
</span><span style=color:#d3869b>212 </span><span style=color:#8ec07c>| fn </span><span style=color:#b8bb26>app_action</span><span style=color:#fbf1c7>() -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>, AppError> {
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|                    ------------------------</span><span style=color:#fbf1c7> expected `AppError` because of this
</span><span style=color:#d3869b>213 </span><span style=color:#8ec07c>|     </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> result1 </span><span style=color:#8ec07c>= db_action</span><span style=color:#fbf1c7>()</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#d3869b>214 </span><span style=color:#8ec07c>|     </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> result2 </span><span style=color:#8ec07c>= db_action</span><span style=color:#fbf1c7>()</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>    |                              ^ the trait `From&lt;url::DbError>` is not implemented for `AppError`
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> note: the question mark operation (`</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>`) implicitly performs a conversion on the error value using the `Fro
</span><span style=color:#fbf1c7>m` </span><span style=color:#fb4934>trait
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> note: required because of the requirements on the </span><span style=color:#fb4934>impl </span><span style=color:#fbf1c7>of `FromResidual&lt;</span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;Infallible, url::DbError>>`
</span><span style=color:#fbf1c7> for `Result&lt;std::string::</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>, AppError>`
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>For more information about this error, try `rustc --explain E0277`.
</span></pre> <p>So it tells me that using <code>?</code> implicitly converts <code>DbError</code> to <code>AppError</code> via the <code>From</code> trait. And because I do not have a trait instance like <code>impl From&lt;DbError> for AppError</code>, it fails.</p> <p>Another thing is I somehow need to bubble up <code>DbError</code> up to the application error somehow. The method I ended up using is to just add a field to the <code>AppError</code> record. It‚Äôs a bit tiring to copy all the <code>DbError</code> variants over to the <code>AppError</code> enum. I mean, it‚Äôs fine for this one since it doesn‚Äôt have that many, but it becomes.</p> <pre style=background-color:#282828>
<span style=color:#fb4934>enum </span><span style=color:#fbf1c7>AppError {
</span><span style=color:#fbf1c7>    DbError(DbError), </span><span style=color:#928374;font-style:italic>// Hooray!
</span><span style=color:#fbf1c7>    Foo,
</span><span style=color:#fbf1c7>    Baz
</span><span style=color:#fbf1c7>}
</span></pre> <p>And then I can create a <code>From&lt;DbError></code> instance:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>impl </span><span style=color:#fabd2f>From</span><span style=color:#fbf1c7>&lt;DbError> </span><span style=color:#fb4934>for </span><span style=color:#fbf1c7>AppError {
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>from</span><span style=color:#fbf1c7>(e: DbError) -> </span><span style=color:#fb4934>Self </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        AppError::DbError(e)
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>}
</span></pre> <p>Which compiles!</p> <p>If I wanted to avoid <code>From</code>, I could do this:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>let</span><span style=color:#fbf1c7> result1 </span><span style=color:#8ec07c>= db_action</span><span style=color:#fbf1c7>().</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|_| AppError::Foo)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span></pre> <p>Except it‚Äôs kinda annoying cause I have to do this at every call site. Although there are times when I did end up using this.</p> <h2 id=application-configuration><a href=#application-configuration>Application configuration</a></h2> <p>While convenient, I can‚Äôt just hard-code everything into the application, especially for a public project. There are a lot of sensitive data like certs, and sometimes it‚Äôs just <em>more</em> convenient for whoever is using the application to change stuff without touching the source code. In my case, I had to make it flexible enough to change database credentials.</p> <blockquote><p>A common way to do it is through environment variables.<p>e.g <code>PG__HOST="db.example.com" emojied</code>. So whenever I need to update stuff, all I have to do is just change the environment variable, and I‚Äôm spared from touching the source code!</blockquote> <p>Here‚Äôs <code>emojied</code>‚Äôs config for it to run:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub struct </span><span style=color:#fbf1c7>AppConfig {
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>/// Application host
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>host</span><span style=color:#fbf1c7>: String,
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>/// PostgreSQL config
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>pg</span><span style=color:#fbf1c7>: tokio_postgres::Config,
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>/// Pool manager config
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>manager</span><span style=color:#fbf1c7>: ManagerConfig,
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>/// Pool size
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>pool_size</span><span style=color:#fbf1c7>: </span><span style=color:#fb4934>usize</span><span style=color:#fbf1c7>,
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>ca_cert_path</span><span style=color:#fbf1c7>: </span><span style=color:#fabd2f>Option</span><span style=color:#fbf1c7>&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>>,
</span><span style=color:#fbf1c7>}
</span></pre> <p>Then I created an associated function for it called <code>from_env/0</code> which returns a <code>Result&lt;AppConfig, Error></code>. I‚Äôll talk about the <code>Error</code> part in the <code>Error Handling</code> section. Then I can use Rust‚Äôs <code>std::env</code> module to get a var‚Äôs value!</p> <p>Here‚Äôs a tiny example:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>use </span><span style=color:#fbf1c7>std::env;
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>struct </span><span style=color:#fbf1c7>AppConfig {
</span><span style=color:#fbf1c7>  </span><span style=color:#83a598>pg_host</span><span style=color:#fbf1c7>: String,
</span><span style=color:#fbf1c7>}
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>impl </span><span style=color:#fbf1c7>AppConfig {
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>from_env</span><span style=color:#fbf1c7>() -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;AppConfig, Error> {
</span><span style=color:#fbf1c7>      </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> host </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>env::var("</span><span style=color:#b8bb26>PG__HOST</span><span style=color:#fbf1c7>")</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>      </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(AppConfig { pg_host: host })
</span><span style=color:#fbf1c7>  }
</span><span style=color:#fbf1c7>}
</span></pre> <blockquote><p>Side note: This kinda looks monadic, where it binds <code>AppConfig</code> to <code>host</code>, and evaluates to <code>Error</code> and ‚Äúexits‚Äù otherwise.</blockquote> ‚Ä¶<h2 id="handling-databasehandler-in-<code>axum</code>"><a href="#handling-databasehandler-in-<code>axum</code>">Handling databasehandler in <code>axum</code></a></h2> <p>I created this database handle that has all the things I need to communicate with the database server:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub struct </span><span style=color:#fbf1c7>Handle {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>pool</span><span style=color:#fbf1c7>: Pool,
</span><span style=color:#fbf1c7>}
</span></pre> <p>It‚Äôs pretty simple. It‚Äôs a struct that has a <code>pool</code> field. Then I created two more functions to make things more convenient: <code>new/1</code>, and <code>client/1</code>.</p> <p><code>new(config: AppConfig) -> Result&lt;Handle, Error></code> expects an <code>AppConfig</code> as an argument, and if all goes well, then a new database handle with all the important things in it. <code>client(&self) -> Result&lt;Pool, Error></code> expects a reference to <code>self</code>, which is <code>Handle</code> in this case. This uses the DB pool to create a new client. From this client, you can do DB queries with it.</p> <pre style=background-color:#282828>
<span style=color:#928374;font-style:italic>// Grabs a client from the pool
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> client </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> handle.</span><span style=color:#8ec07c>client</span><span style=color:#fbf1c7>().await</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic>// Runs a query that gets a URL's stats
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> data </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> client
</span><span style=color:#fbf1c7>    .</span><span style=color:#8ec07c>query</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>SELECT * FROM app.get_url_stats($1)</span><span style=color:#fbf1c7>", </span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>[</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>identifier])
</span><span style=color:#fbf1c7>    .await</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic>// Manually maps the row to a leaderboard entry
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> db_id </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> data[</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>].</span><span style=color:#8ec07c>try_get</span><span style=color:#fbf1c7>(</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> db_clicks </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> data[</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>].</span><span style=color:#8ec07c>try_get</span><span style=color:#fbf1c7>(</span><span style=color:#d3869b>1</span><span style=color:#fbf1c7>)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> db_url </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> data[</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>].</span><span style=color:#8ec07c>try_get</span><span style=color:#fbf1c7>(</span><span style=color:#d3869b>2</span><span style=color:#fbf1c7>)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(leaderboard::Entry {
</span><span style=color:#fbf1c7>    identifier: db_id,
</span><span style=color:#fbf1c7>    clicks: db_clicks,
</span><span style=color:#fbf1c7>    url: db_url,
</span><span style=color:#fbf1c7>})
</span></pre> <p>Okay, so I somehow need access to the database handle in the ‚Äúcontrollers‚Äù, like in <code>controllers::leaderboard</code>.</p> <blockquote><p>I‚Äôm only calling it a controller since it‚Äôs a common concept. <code>axum</code> doesn‚Äôt call it that.</blockquote> <pre style=background-color:#282828>
<span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>    .</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard));
</span></pre> <p><code>axum</code> recommends <sup class=footnote-reference><a href=#2>2</a></sup> mentions that you could use ‚Äúrequest extensions‚Äù which looks like it acts like middleware. It recommends to have <code>Arc</code> inhabit <code>Extension</code> (<code>Extension&lt;Arc&lt;T>></code>), but why?</p> <p>Time to do it in some wrong ways. This is fine since <code>rustc</code> is quite helpful with its error messages.</p> <p>I‚Äôll try to move <code>handle</code> instead:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>use </span><span style=color:#fbf1c7>axum::{extract::Extension, routing::get, Router};
</span><span style=color:#fb4934>use </span><span style=color:#fbf1c7>std::net::SocketAddr;
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>run</span><span style=color:#fbf1c7>(handle: db::Handle) -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;(), hyper::Error> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard))
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>layer</span><span style=color:#fbf1c7>(Extension(handle));
</span><span style=color:#fbf1c7>                      </span><span style=color:#928374;font-style:italic>// ^ Here
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> addr </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>SocketAddr::from(([</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>], </span><span style=color:#d3869b>3000</span><span style=color:#fbf1c7>));
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    axum::Server::bind(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>addr)
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>serve</span><span style=color:#fbf1c7>(app.</span><span style=color:#8ec07c>into_make_service</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>with_graceful_shutdown</span><span style=color:#fbf1c7>(</span><span style=color:#8ec07c>signal_shutdown</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .await
</span><span style=color:#fbf1c7>}
</span></pre> <p>Doing that gives me this error:</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>error[</span><span style=color:#d3869b>E0277</span><span style=color:#fbf1c7>]: the </span><span style=color:#fb4934>trait </span><span style=color:#fbf1c7>bound `db::Handle: Clone` is not satisfied
</span><span style=color:#fbf1c7>  --> src/lib.rs:36:16
</span><span style=color:#fbf1c7>   |
</span><span style=color:#fbf1c7>36 |         .layer(Extension(handle));
</span><span style=color:#fbf1c7>   |          ----- ^^^^^^^^^^^^^^^^^ the trait `Clone` is not implemented for `db::Handle`
</span><span style=color:#fbf1c7>   |          |
</span><span style=color:#fbf1c7>   |          required by a bound introduced by this call
</span><span style=color:#fbf1c7>   |
</span><span style=color:#fbf1c7>   = note: required because of the requirements on the impl of `tower_layer::Layer&lt;Route&lt;_>>` for `Extension&lt;db::
</span><span style=color:#fbf1c7>Handle>`
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>For more information about this error, try `rustc --explain E0277`.
</span></pre> <p>It seems like I need to derive <code>Clone</code> for <code>db::Handle</code> since it probably gets cloned every time, although I‚Äôm not sure exactly when it does get cloned. In every new request?</p> <p>So what happens if I <em>do</em> derive <code>Clone</code>?</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>#[</span><span style=color:#83a598>derive</span><span style=color:#fbf1c7>(Clone)]
</span><span style=color:#fb4934>struct </span><span style=color:#fbf1c7>Handle {
</span><span style=color:#fbf1c7>  </span><span style=color:#fb4934>pub </span><span style=color:#83a598>pool</span><span style=color:#fbf1c7>: Pool
</span><span style=color:#fbf1c7>}
</span></pre> <p>Then I need to make sure that the function‚Äôs type signature matches:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>leaderboard</span><span style=color:#fbf1c7>(
</span><span style=color:#fbf1c7>    Extension(handle): Extension&lt;db::Handle>
</span><span style=color:#fbf1c7> </span><span style=color:#928374;font-style:italic>// ^ Here! axum seems to know exactly where to apply it to the args. Not sure
</span><span style=color:#fbf1c7> </span><span style=color:#928374;font-style:italic>// how this is done (yet).
</span><span style=color:#fbf1c7>) -> (StatusCode, Markup) {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>match </span><span style=color:#fbf1c7>leaderboard::fetch(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>handle).await {
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(entries) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>            (StatusCode::</span><span style=color:#d3869b>OK</span><span style=color:#fbf1c7>, views::leaderboard::render(entries))
</span><span style=color:#fbf1c7>        },
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Err</span><span style=color:#fbf1c7>(_e) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>(StatusCode::</span><span style=color:#d3869b>INTERNAL_SERVER_ERROR</span><span style=color:#fbf1c7>, maud::html</span><span style=color:#8ec07c>! </span><span style=color:#fbf1c7>{}),
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>}
</span></pre> <p>Well, it seems to compile just fine. The leaderboard page works fine as well. I don‚Äôt really have that much experience with this yet but my current assumption is that I‚Äôm required to derive <code>Clone</code> for <code>Handle</code> since there‚Äôs no way to do shared ownership. So what it does is that it ends up cloning it every time. But, what if I don‚Äôt want to clone it? What if I just pass around references?</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>run</span><span style=color:#fbf1c7>(handle: db::Handle) -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;(), hyper::Error> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard))
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>layer</span><span style=color:#fbf1c7>(Extension(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>handle));
</span><span style=color:#fbf1c7>                      </span><span style=color:#928374;font-style:italic>// ^ Here
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> addr </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>SocketAddr::from(([</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>], </span><span style=color:#d3869b>3000</span><span style=color:#fbf1c7>));
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    axum::Server::bind(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>addr)
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>serve</span><span style=color:#fbf1c7>(app.</span><span style=color:#8ec07c>into_make_service</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>with_graceful_shutdown</span><span style=color:#fbf1c7>(</span><span style=color:#8ec07c>signal_shutdown</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .await
</span></pre> <p>Compiles with this helpful error message:</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>error[</span><span style=color:#d3869b>E0597</span><span style=color:#fbf1c7>]: `handle` does not live long enough
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>-</span><span style=color:#fbf1c7>-> src</span><span style=color:#8ec07c>/</span><span style=color:#fbf1c7>lib.rs:</span><span style=color:#d3869b>36</span><span style=color:#fbf1c7>:</span><span style=color:#d3869b>26
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>|
</span><span style=color:#d3869b>22 </span><span style=color:#8ec07c>|       </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>|  </span><span style=color:#d3869b>_______________</span><span style=color:#8ec07c>-
</span><span style=color:#d3869b>23 </span><span style=color:#8ec07c>| |         </span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard))
</span><span style=color:#d3869b>24 </span><span style=color:#8ec07c>| |         </span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c>layer</span><span style=color:#fbf1c7>(Extension(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>handle));
</span><span style=color:#fbf1c7>   | |</span><span style=color:#d3869b>__________________________</span><span style=color:#8ec07c>^^^^^^^_-</span><span style=color:#fbf1c7> argument requires that `handle` is borrowed </span><span style=color:#fb4934>for</span><span style=color:#fbf1c7> `</span><span style=color:#fb4934>'static</span><span style=color:#fbf1c7>`
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>|                            |
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>|</span><span style=color:#fbf1c7>                            borrowed value does not live long enough
</span><span style=color:#8ec07c>...
</span><span style=color:#d3869b>44 </span><span style=color:#8ec07c>|</span><span style=color:#fbf1c7>   }
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>|   -</span><span style=color:#fbf1c7> `handle` dropped here </span><span style=color:#fb4934>while</span><span style=color:#fbf1c7> still borrowed
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>For more information about this error, try `rustc </span><span style=color:#8ec07c>--</span><span style=color:#fbf1c7>explain </span><span style=color:#d3869b>E0597</span><span style=color:#fbf1c7>`.
</span></pre> <p>Unfortunately, I‚Äôm not too familiar with how lifetimes work in <code>async</code>/<code>await</code>. But it looks like since it‚Äôs non-blocking, <code>handle</code> gets dropped since the function reaches the end of its scope while the server is still running.</p> <blockquote><p>This is all just somewhat smart guessing though. I‚Äôm gonna need to do more reading on this topic.</blockquote> <p>Wait, what about <code>app</code> then? Won‚Äôt this get dropped as well? I wanted to confirm if this did get moved, or if it did some other trickery I had no idea about:</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard))
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>layer</span><span style=color:#fbf1c7>(Extension(handle));
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> addr </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>SocketAddr::from(([</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>], </span><span style=color:#d3869b>3000</span><span style=color:#fbf1c7>));
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> foo </span><span style=color:#8ec07c>=
</span><span style=color:#fbf1c7>        axum::Server::bind(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>addr)
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>serve</span><span style=color:#fbf1c7>(app.</span><span style=color:#8ec07c>into_make_service</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>with_graceful_shutdown</span><span style=color:#fbf1c7>(</span><span style=color:#8ec07c>signal_shutdown</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>            .await;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    println!("</span><span style=color:#8ec07c>{:?}</span><span style=color:#fbf1c7>", app);
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    foo
</span></pre> <p>So if <code>app</code> does get moved, then <code>rustc</code> should complain about me accessing a variable with no ownership; which it does:</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>error[</span><span style=color:#d3869b>E0382</span><span style=color:#fbf1c7>]: borrow of moved value: `app`
</span><span style=color:#fbf1c7>   </span><span style=color:#8ec07c>-</span><span style=color:#fbf1c7>-> src</span><span style=color:#8ec07c>/</span><span style=color:#fbf1c7>lib.rs:</span><span style=color:#d3869b>46</span><span style=color:#fbf1c7>:</span><span style=color:#d3869b>22
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|
</span><span style=color:#d3869b>22  </span><span style=color:#8ec07c>|     </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|         --- </span><span style=color:#fb4934>move</span><span style=color:#fbf1c7> occurs because `app` has </span><span style=color:#fb4934>type</span><span style=color:#fbf1c7> `Router`, which does not implement the `</span><span style=color:#fabd2f>Copy</span><span style=color:#fbf1c7>` </span><span style=color:#fb4934>trait
</span><span style=color:#8ec07c>...
</span><span style=color:#d3869b>42  </span><span style=color:#8ec07c>|             </span><span style=color:#fbf1c7>.</span><span style=color:#8ec07c>serve</span><span style=color:#fbf1c7>(app.</span><span style=color:#8ec07c>into_make_service</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|                        -------------------</span><span style=color:#fbf1c7> `app` moved due to this method call
</span><span style=color:#8ec07c>...
</span><span style=color:#d3869b>46  </span><span style=color:#8ec07c>|     </span><span style=color:#fbf1c7>println!("</span><span style=color:#8ec07c>{:?}</span><span style=color:#fbf1c7>", app);
</span><span style=color:#fbf1c7>    |                      ^^^ value borrowed here after move
</span><span style=color:#fbf1c7>    </span><span style=color:#8ec07c>|
</span><span style=color:#fbf1c7>note: this function takes ownership of the receiver `</span><span style=color:#d3869b>self</span><span style=color:#fbf1c7>`, which moves `app`
</span></pre> <p>Phew! It‚Äôs almost like I‚Äôm encouraged to try out all the failed scenarios to learn a lot of things since the compiler is quite helpful.</p> <p>Okay, since I didn‚Äôt want this to get cloned all the time, I will just follow what <code>axum</code> used in its examples - the usage of <code>Arc&lt;T></code>:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>run</span><span style=color:#fbf1c7>(handle: db::Handle) -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;(), hyper::Error> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> handle </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Arc::new(handle);
</span><span style=color:#fbf1c7>    </span><span style=color:#928374;font-style:italic>//  ^ Shadow previous binding with `Arc&lt;db::Handle>`
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> app </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Router::new()
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>route</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>/leaderboard</span><span style=color:#fbf1c7>", routing::get(controllers::leaderboard))
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>layer</span><span style=color:#fbf1c7>(Extension(handle));
</span><span style=color:#fbf1c7>                      </span><span style=color:#928374;font-style:italic>// ^ Here
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> addr </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>SocketAddr::from(([</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>, </span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>], </span><span style=color:#d3869b>3000</span><span style=color:#fbf1c7>));
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    axum::Server::bind(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>addr)
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>serve</span><span style=color:#fbf1c7>(app.</span><span style=color:#8ec07c>into_make_service</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>with_graceful_shutdown</span><span style=color:#fbf1c7>(</span><span style=color:#8ec07c>signal_shutdown</span><span style=color:#fbf1c7>())
</span><span style=color:#fbf1c7>        .await
</span><span style=color:#fbf1c7>}
</span></pre> <p>And then I‚Äôll remove the <code>Clone</code> derivation:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub struct </span><span style=color:#fbf1c7>Handle {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>pub </span><span style=color:#83a598>pool</span><span style=color:#fbf1c7>: Pool,
</span><span style=color:#fbf1c7>}
</span></pre> <p>So if I‚Äôm not mistaken, which I probably am, <code>Arc&lt;T></code> should allow me to share ownership of <code>db::Handle</code> without having to clone it <sup class=footnote-reference><a href=#3>3</a></sup>.</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>leaderboard</span><span style=color:#fbf1c7>(
</span><span style=color:#fbf1c7>    Extension(handle): Extension&lt;Arc&lt;db::Handle>>
</span><span style=color:#fbf1c7>) -> (StatusCode, Markup) {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>match </span><span style=color:#fbf1c7>leaderboard::fetch(</span><span style=color:#8ec07c>&*</span><span style=color:#fbf1c7>handle).await {
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(entries) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>            (StatusCode::</span><span style=color:#d3869b>OK</span><span style=color:#fbf1c7>, views::leaderboard::render(entries))
</span><span style=color:#fbf1c7>        },
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Err</span><span style=color:#fbf1c7>(_e) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>(StatusCode::</span><span style=color:#d3869b>INTERNAL_SERVER_ERROR</span><span style=color:#fbf1c7>, maud::html</span><span style=color:#8ec07c>! </span><span style=color:#fbf1c7>{}),
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>}
</span></pre> <p>Then in <code>leaderboard::fetch/1</code>:</p> <pre style=background-color:#282828>
<span style=color:#fb4934>pub</span><span style=color:#fbf1c7> async </span><span style=color:#8ec07c>fn </span><span style=color:#b8bb26>fetch_url</span><span style=color:#fbf1c7>(
</span><span style=color:#fbf1c7>    handle: </span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>db::Handle,
</span><span style=color:#fbf1c7>    identifier: String
</span><span style=color:#fbf1c7>) -> </span><span style=color:#fabd2f>Result</span><span style=color:#fbf1c7>&lt;</span><span style=color:#fabd2f>String</span><span style=color:#fbf1c7>, Error> {
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> client </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> handle.</span><span style=color:#8ec07c>client</span><span style=color:#fbf1c7>().await</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>    </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> row </span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7> client
</span><span style=color:#fbf1c7>        .</span><span style=color:#8ec07c>query_one</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>SELECT app.get_url($1)</span><span style=color:#fbf1c7>", </span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>[</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>identifier])
</span><span style=color:#fbf1c7>        .await</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    row.</span><span style=color:#8ec07c>try_get</span><span style=color:#fbf1c7>(</span><span style=color:#d3869b>0</span><span style=color:#fbf1c7>).</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|e| Error::from(e))
</span><span style=color:#fbf1c7>}
</span></pre> <p>Although, I had to manually dereference it to get the reference to <code>Handle</code>. It‚Äôs also a good thing that I don‚Äôt have to mutate <code>handle</code> at all because otherwise this would‚Äôve been a more painful experience.</p> <h2 id=connecting-to-a-managed-database><a href=#connecting-to-a-managed-database>Connecting to a managed database</a></h2> <p>Initially, I used <code>sqlx</code> as the db library since it gets recommended in almost every post about SQL libraries on the Rust subreddit. It worked fine for me until I had to get it to connect to DO‚Äôs managed DB. It required me to connect to it via TLS, and it wasn‚Äôt a pleasant experience trying to debug what‚Äôs wrong with <code>sqlx</code>, so I ditched it settled with <code>tokio-postgres</code>, <code>deadpool-postgres</code>, and <code>native-tls</code>. Oh, I also had a difficult time <sup class=footnote-reference><a href=#9>4</a></sup> with <code>rustls</code> since it didn‚Äôt seem to like DO‚Äôs CA certificate, which is why I settled with <code>native-tls</code>.</p> <p><code>native-tls</code> needed OpenSSL setup, which I was able to do with Nix (for the dev environment):</p> <pre style=background-color:#282828>
<span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># ...
</span><span style=color:#fbf1c7>        devShell </span><span style=color:#fbf1c7;background-color:#fb4934>=</span><span style=color:#fbf1c7> pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>mkShell {
</span><span style=color:#fbf1c7>          </span><span style=color:#928374;font-style:italic># inherit (self.checks.${system}.pre-commit-check) shellHook;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>buildInputs </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>with </span><span style=color:#fbf1c7>pkgs; [
</span><span style=color:#fbf1c7>            </span><span style=color:#928374;font-style:italic># Back-end
</span><span style=color:#fbf1c7>            pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>rustc
</span><span style=color:#fbf1c7>            pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>cargo
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>            pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>openssl
</span><span style=color:#fbf1c7>            pkgs</span><span style=color:#8ec07c>.</span><span style=color:#fbf1c7>pkg-config
</span><span style=color:#fbf1c7>          ];
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>          </span><span style=color:#fabd2f>PKG_CONFIG_PATH </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>"</span><span style=color:#8ec07c;font-style:italic>${</span><span style=color:#fbf1c7;font-style:italic>pkgs</span><span style=color:#8ec07c;font-style:italic>.</span><span style=color:#fbf1c7;font-style:italic>openssl</span><span style=color:#8ec07c;font-style:italic>.</span><span style=color:#fbf1c7;font-style:italic>dev</span><span style=color:#8ec07c;font-style:italic>}</span><span style=color:#b8bb26>/lib/pkgconfig</span><span style=color:#fbf1c7>";
</span><span style=color:#fbf1c7>        }</span><span style=color:#fbf1c7;background-color:#fb4934>;</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>  </span><span style=color:#928374;font-style:italic># ...
</span></pre> <p>So I had to provide the CA cert during runtime, not build-time since: 1) it‚Äôll be easier to distribute the static binary and Docker image, and 2) some CA certs are only given during runtime (like DO if ever you‚Äôre using app platform). This was my process:</p> <ol><li>Build static binary & image without CA certs and other DB secrets<li>When the image runs, it‚Äôs assumed that the necessary environment variables, like one that contains the certificate contents, exist.<li>Write the certificate contents to a file.<li>Run <code>emojied</code></ol> <p>This seems to be a pretty standard process, although this is fairly tedious.</p> <pre style=background-color:#282828>
<span style=color:#928374;font-style:italic>// src/config.rs
</span><span style=color:#fb4934>use </span><span style=color:#fbf1c7>tokio_postgres::config::SslMode;
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>let mut</span><span style=color:#fbf1c7> pg_config </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>tokio_postgres::Config::new();
</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic>// I also read other PG values like hostname, DB name, user, etc. but excluded
</span><span style=color:#928374;font-style:italic>// those for brevity.
</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic>// Not providing CA_CERT is fine
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> ca_cert_path </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>match </span><span style=color:#fbf1c7>env::var("</span><span style=color:#b8bb26>PG__CA_CERT</span><span style=color:#fbf1c7>") {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>Ok</span><span style=color:#fbf1c7>(path) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic>// I think `Prefer` is fine as well, which is the default
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic>// for `tokio-postgres`.
</span><span style=color:#fbf1c7>        pg_config.</span><span style=color:#8ec07c>ssl_mode</span><span style=color:#fbf1c7>(SslMode::Require);
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>Some</span><span style=color:#fbf1c7>(path)
</span><span style=color:#fbf1c7>    },
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>Err</span><span style=color:#fbf1c7>(_e) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#fabd2f>None
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>};
</span></pre> <p>I allowed it to continue running without the cert path in <code>PG__CA_CERT</code> for dev environments.</p> <pre style=background-color:#282828>
<span style=color:#928374;font-style:italic>// Somewhere in src/db.rs
</span><span style=color:#fbf1c7>
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> manager </span><span style=color:#8ec07c>= </span><span style=color:#fb4934>match</span><span style=color:#fbf1c7> app_config.ca_cert_path {
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>Some</span><span style=color:#fbf1c7>(ca_cert_path) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic>// Read file into byte vector
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> cert </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>std::fs::read(ca_cert_path)
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|e| Error::CACertFileError(e))</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#928374;font-style:italic>// Create a certificate from a PEM file
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> ntls_cert </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Certificate::from_pem(</span><span style=color:#8ec07c>&</span><span style=color:#fbf1c7>cert)
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|_| Error::InvalidCACert)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> tls </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>TlsConnector::builder()
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>add_root_certificate</span><span style=color:#fbf1c7>(ntls_cert)
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>build</span><span style=color:#fbf1c7>()
</span><span style=color:#fbf1c7>            .</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|_| Error::FailedToBuildTlsConnector)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        </span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> conn </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>MakeTlsConnector::new(tls);
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>        Manager::from_config(app_config.pg, conn, app_config.manager)
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>    </span><span style=color:#fabd2f>None </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>Manager::from_config(app_config.pg, NoTls, app_config.manager),
</span><span style=color:#fbf1c7>};
</span><span style=color:#fbf1c7>
</span><span style=color:#928374;font-style:italic>// Since we need a `manager` to build a pool
</span><span style=color:#fb4934>let</span><span style=color:#fbf1c7> pool </span><span style=color:#8ec07c>= </span><span style=color:#fbf1c7>Pool::builder(manager)
</span><span style=color:#fbf1c7>    .</span><span style=color:#8ec07c>max_size</span><span style=color:#fbf1c7>(app_config.pool_size)
</span><span style=color:#fbf1c7>    .</span><span style=color:#8ec07c>build</span><span style=color:#fbf1c7>()
</span><span style=color:#fbf1c7>    .</span><span style=color:#8ec07c>map_err</span><span style=color:#fbf1c7>(|_| Error::FailedToBuildPool)</span><span style=color:#8ec07c>?</span><span style=color:#fbf1c7>;
</span></pre> <blockquote><p>The process was quite similar with SQLx but there was something, that I don‚Äôt really remember anymore, which made it so frustrating to work with.</blockquote> <p>Unfortunately, DO doesn‚Äôt support multiline environment variables, for some reason, so cramming everything including the <code>BEGIN CERTIFICATE</code> and <code>END CERTIFICATE</code> into one line resulted in it getting rejected. So, I just got what‚Äôs in between, and manually appended it to the file instead.</p> <pre style=background-color:#282828>
<span style=color:#8ec07c>echo </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Dumping CA certificate to /app/ca-certificate.crt</span><span style=color:#fbf1c7>"
</span><span style=color:#8ec07c>echo </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>-----BEGIN CERTIFICATE-----</span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>></span><span style=color:#fbf1c7> /app/ca-certificate.crt
</span><span style=color:#8ec07c>echo </span><span style=color:#458588>$</span><span style=color:#83a598>CA_CERT </span><span style=color:#8ec07c>>></span><span style=color:#fbf1c7> /app/ca-certificate.crt
</span><span style=color:#8ec07c>echo </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>-----END CERTIFICATE-----</span><span style=color:#fbf1c7>" </span><span style=color:#8ec07c>>></span><span style=color:#fbf1c7> /app/ca-certificate.crt
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>echo </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Executing emojied</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>
</span><span style=color:#8ec07c>./emojied
</span></pre> <p>Kind of hacky, and inconvenient especially if I forget. But it works!</p> <h2 id=url-redirect-woes><a href=#url-redirect-woes>URL redirect woes</a></h2> <p>This is a short one. For the redirect, I returned an HTTP status 301 <sup class=footnote-reference><a href=#4>5</a></sup> with a response containing the URL to redirect to. So the process goes something like this:</p> <ol><li>Enter <a href=https://emojied.net/%F0%9F%8D%8A%F0%9F%8C%90>https://emojied.net/üçäüåê</a> in the browser.<li><code>emojied</code> looks for an entry with <code>üçäüåê</code>, and gets the associated URL.<li>Respond with an HTTP 301 and the URL<li>Browser automatically performs the redirect</ol> <p>Unfortunately, and I spent 30mins on this scratching my head why this was happening, the request would get cached, and this is bad! It‚Äôs bad because I had to increment the <code>clicks</code> column every time the link is visited. But if it‚Äôs cached, then the server won‚Äôt bother to call the functions it needs to call!</p> <p>Then, I found out that <code>301</code> gets cached automatically by the browser <sup class=footnote-reference><a href=#5>6</a></sup>, and that I needed to use <code>302</code>.</p> <h2 id="html-templating-with-<code>maud</code>"><a href="#html-templating-with-<code>maud</code>">HTML templating with <code>maud</code></a></h2> <p>I had a pleasant experience with server-side templating while I was building a Haskell project called <a href=https://swoogle.sekun.dev>swoogle</a>. I used <code>lucid</code> <sup class=footnote-reference><a href=#6>7</a></sup> which was a pretty darn elegant HTML DSL.</p> <pre style=background-color:#282828>
<span style=color:#8ec07c>--</span><span style=color:#fbf1c7> Category options
</span><span style=color:#8ec07c>select_
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>[</span><span style=color:#fbf1c7> id_ "</span><span style=color:#b8bb26>category-options</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>,</span><span style=color:#fbf1c7> name_ "</span><span style=color:#b8bb26>resource</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>,</span><span style=color:#fbf1c7> class_ "</span><span style=color:#b8bb26>bg-white font-semibold dark:bg-su-dark-bg-alt text-su-fg dark:text-su-dark-fg</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>,</span><span style=color:#fbf1c7> required_ "</span><span style=color:#b8bb26>required</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>]</span><span style=color:#fbf1c7> $ do
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>disabled_ "</span><span style=color:#b8bb26>disabled</span><span style=color:#fbf1c7>", selected_ "</span><span style=color:#b8bb26>selected</span><span style=color:#fbf1c7>", value_ ""</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Category</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>people</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>People</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>film</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Film</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>starship</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Starship</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>vehicle</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Vehicle</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>species</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Species</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>  </span><span style=color:#8ec07c>option_ </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>value_ "</span><span style=color:#b8bb26>planet</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>Planet</span><span style=color:#fbf1c7>"
</span></pre> <p>Well, I wanted something like that in Rust, and I found <code>maud</code> <sup class=footnote-reference><a href=#7>8</a></sup>. I did run into a problem when I tried to use its latest version with <code>axum</code> since something must‚Äôve changed in <code>axum</code>, so I had to pull from the <code>main</code> instead:</p> <pre style=background-color:#282828>
<span style=color:#8ec07c>[dependencies]
</span><span style=color:#8ec07c>...
</span><span style=color:#8ec07c>maud</span><span style=color:#fbf1c7> = { git = "</span><span style=color:#b8bb26>https://github.com/lambda-fairy/maud</span><span style=color:#fbf1c7>", branch = "</span><span style=color:#b8bb26>main</span><span style=color:#fbf1c7>", features = </span><span style=color:#fb4934>[</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>axum</span><span style=color:#fbf1c7>"</span><span style=color:#fb4934>] </span><span style=color:#fbf1c7>}
</span><span style=color:#8ec07c>...
</span></pre> <p>So with this, I could do stuff like:</p> <pre style=background-color:#282828>
<span style=color:#8ec07c>fn </span><span style=color:#b8bb26>foo</span><span style=color:#fbf1c7>() -> Markup {
</span><span style=color:#fbf1c7>  html! {
</span><span style=color:#fbf1c7>    ("</span><span style=color:#b8bb26>Hello</span><span style=color:#fbf1c7>")
</span><span style=color:#fbf1c7>    h1 class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>text-red-500</span><span style=color:#fbf1c7>" { ("</span><span style=color:#b8bb26>Hello!</span><span style=color:#fbf1c7>") }
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    h2 class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>("</span><span style=color:#b8bb26>font-semibold</span><span style=color:#fbf1c7>") { ("</span><span style=color:#b8bb26>Hey</span><span style=color:#fbf1c7>") }
</span><span style=color:#fbf1c7>  }
</span><span style=color:#fbf1c7>}
</span></pre> <h2 id="<code><noscript></code>-tag,-and-problems-with-js-toggling-extensions"><a href="#<code><noscript></code>-tag,-and-problems-with-js-toggling-extensions"><code><noscript>tag, and problems with JS toggling extensions <p>I wanted to have the website work with JS disabled because, well, it was a very simple website. There was no reason why I couldn‚Äôt make all the important features work without JS!</p> <p>So I ended up making heavy use of the <code>&lt;noscript></code> tag, since it allowed me to display alternative content when the browser has JS disabled. You‚Äôll see it littered all over the codebase, like so:</p> <pre style=background-color:#282828>
<span style=color:#8ec07c>@</span><span style=color:#fb4934>match</span><span style=color:#fbf1c7> data {
</span><span style=color:#fbf1c7>    RootData::Auto(</span><span style=color:#8ec07c>_</span><span style=color:#fbf1c7>) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        noscript {
</span><span style=color:#fbf1c7>            div class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>w-full sm:w-4/5 mt-2 mx-auto text-su-fg-1 dark:text-su-dark-fg-1</span><span style=color:#fbf1c7>" {
</span><span style=color:#fbf1c7>                a href</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>?custom_url=t</span><span style=color:#fbf1c7>" </span><span style=color:#fb4934>type</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>button</span><span style=color:#fbf1c7>" class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>font-medium underline</span><span style=color:#fbf1c7>" {
</span><span style=color:#fbf1c7>                    "</span><span style=color:#b8bb26>Custom URL</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>                }
</span><span style=color:#fbf1c7>            }
</span><span style=color:#fbf1c7>        }
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>
</span><span style=color:#fbf1c7>    RootData::Custom(</span><span style=color:#8ec07c>_</span><span style=color:#fbf1c7>) </span><span style=color:#8ec07c>=> </span><span style=color:#fbf1c7>{
</span><span style=color:#fbf1c7>        noscript {
</span><span style=color:#fbf1c7>            div class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>w-full sm:w-4/5 mt-2 mx-auto text-su-fg-1 dark:text-su-dark-fg-1</span><span style=color:#fbf1c7>" {
</span><span style=color:#fbf1c7>                a href</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>/</span><span style=color:#fbf1c7>" </span><span style=color:#fb4934>type</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>button</span><span style=color:#fbf1c7>" class</span><span style=color:#8ec07c>=</span><span style=color:#fbf1c7>"</span><span style=color:#b8bb26>font-medium underline</span><span style=color:#fbf1c7>" {
</span><span style=color:#fbf1c7>                    "</span><span style=color:#b8bb26>Autogenerate a custom URL for me</span><span style=color:#fbf1c7>"
</span><span style=color:#fbf1c7>                }
</span><span style=color:#fbf1c7>            }
</span><span style=color:#fbf1c7>        }
</span><span style=color:#fbf1c7>    }
</span><span style=color:#fbf1c7>}
</span></pre> <p>These only get rendered by the browser when JS is disabled. But what do browser extensions like <code>NoScript</code> when it ‚Äúdisables‚Äù JS? It‚Äôs something like this:</p> <ol><li>Block requests for JS files via CSP (Content Security Policies)<li>Replace <code>noscript</code> tags to <code>span</code> or <code>div</code> tags</ol> <p>The problem I ended up with was in #2. Why? Because the <code>noscript</code> tag attributes weren‚Äôt copied over to the new <code>span</code>/<code>div</code> tags. And that breaks a lot of stuff.</p> <p>So while <code>emojied</code> does work without JS, it won‚Äôt work due to how the extensions work <sup class=footnote-reference><a href=#8>9</a></sup>.</p> <h2 id=conclusion><a href=#conclusion>Conclusion</a></h2> <p>Alright, that was a lot. I did learn a lot from this experience. I actually only read until chapter 10 of the Rust Book, and skipped to some parts like advanced traits, and other things. I really like the fact that there‚Äôs a detailed book that talks about some idiomatic Rust patterns, and even the more advanced stuff, that‚Äôs completely <strong>FREE</strong>. How crazy is that? My wallet is spared!</p> <p>I usually try to avoid failure, even in Haskell, cause its error messages are pretty bad. When I started out, it was pretty much worthless to read GHC‚Äôs error messages since it would just confuse me even more. It was only until I had people guide me (like justosophy, thank you) that I slowly got to understand what GHC was trying to tell me. With Rust though, it‚Äôs a completely different experience.</p> <p>I like <em>failing</em> because Rust is very helpful with its error messages. In fact, I discover new things by reading it so I‚Äôm not punished for trying out different things that don‚Äôt work just to gain more insight.</p> <p>I also like that it‚Äôs fairly easy on resources. I didn‚Äôt even bother optimizing this at all since I mostly have no idea what I‚Äôm doing, and I‚Äôm trying to avoid having to deal with lifetimes as much as possible. I‚Äôm hosting this on a 1x shared vCPU + 512MB RAM, and it didn‚Äôt break a sweat during peak load.</p> <p>Anyway, so far, so good! I‚Äôm pretty ecstatic to continue learning Rust.</p> <h2 id=footnotes><a href=#footnotes>Footnotes</a></h2> <div class=footnote-definition id=1><sup class=footnote-definition-label>1</sup><p><a href=https://github.com/gnawex/gnawex>https://github.com/gnawex/gnawex</a></div> <div class=footnote-definition id=2><sup class=footnote-definition-label>2</sup><p><a href=https://docs.rs/axum/0.5.1/axum/#using-request-extensions>https://docs.rs/axum/0.5.1/axum/#using-request-extensions</a></div> <div class=footnote-definition id=3><sup class=footnote-definition-label>3</sup><p><a href=https://doc.rust-lang.org/std/sync/struct.Arc.html>https://doc.rust-lang.org/std/sync/struct.Arc.html</a></div> <div class=footnote-definition id=4><sup class=footnote-definition-label>5</sup><p><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/301>https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/301</a></div> <div class=footnote-definition id=5><sup class=footnote-definition-label>6</sup><p><a href=https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching#targets_of_caching_operations>https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching#targets_of_caching_operations</a></div> <div class=footnote-definition id=6><sup class=footnote-definition-label>7</sup><p><a href=https://hackage.haskell.org/package/lucid>https://hackage.haskell.org/package/lucid</a></div> <div class=footnote-definition id=7><sup class=footnote-definition-label>8</sup><p><a href=https://github.com/lambda-fairy/maud>https://github.com/lambda-fairy/maud</a></div> <div class=footnote-definition id=8><sup class=footnote-definition-label>9</sup><p><a href=https://github.com/hackademix/noscript/issues/238>https://github.com/hackademix/noscript/issues/238</a></div> <div class=footnote-definition id=9><sup class=footnote-definition-label>4</sup><p><a href=https://old.reddit.com/r/rust/comments/txglob/need_help_regarding_deadpoolpostgres_rustls_and/>https://old.reddit.com/r/rust/comments/txglob/need_help_regarding_deadpoolpostgres_rustls_and/</a></div> <div class=footnote-definition id=10><sup class=footnote-definition-label>10</sup><p><a href=https://www.manning.com/books/rust-in-action>https://www.manning.com/books/rust-in-action</a></div> <footer><img src=/assets/images/not-by-ai.png style=width:8rem><div>Copyright <a href=https://github.com/sekunho>SEKUN</a> 2022-2025. Generated by <a href=/projects/puggle><code>puggle</code></a>.</div></footer> <a href=https://mastodon.social/@sekun rel=me style=display:none>Mastodon</a> <script>(function a(b){b.querySelectorAll(`template[shadowrootmode]`).forEach(b=>{const c=b.getAttribute(`shadowrootmode`);const d=b.parentNode.attachShadow({mode:c});d.appendChild(b.content);b.remove();a(d)})})(document)</script>